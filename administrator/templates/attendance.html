{% extends "base_new.html" %}

{% block title %}Attendance & Check-ins - Emergency Management System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold text-primary">
                        <i class="fas fa-users me-3"></i>Attendance & Safety Check-ins
                    </h1>
                    <p class="text-muted mb-0">Monitor student and staff safety status in real-time</p>
                </div>
                <div>
                    <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#bulkCheckinModal">
                        <i class="fas fa-users-cog me-2"></i>Bulk Check-in
                    </button>
                    <button class="btn btn-primary" onclick="exportData('checkins')">
                        <i class="fas fa-download me-2"></i>Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Overview Cards -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card dashboard-card bg-success text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="display-5 fw-bold">{{ stats.safe }}</div>
                        <div class="card-title mb-0">I'm Safe</div>
                        <small class="opacity-75">
                            <i class="fas fa-percentage me-1"></i>
                            {{ ((stats.safe / stats.total * 100) | round(1)) if stats.total > 0 else 0 }}% of total
                        </small>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-shield-alt fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card dashboard-card bg-warning text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="display-5 fw-bold">{{ stats.stuck }}</div>
                        <div class="card-title mb-0">I'm Stuck</div>
                        <small class="opacity-75">
                            <i class="fas fa-exclamation me-1"></i>
                            Needs assistance
                        </small>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-hand-paper fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card dashboard-card bg-danger text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="display-5 fw-bold">{{ stats.unknown }}</div>
                        <div class="card-title mb-0">No Response</div>
                        <small class="opacity-75">
                            <i class="fas fa-question me-1"></i>
                            Status unknown
                        </small>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-question-circle fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card dashboard-card bg-info text-white h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="display-5 fw-bold">{{ stats.total }}</div>
                        <div class="card-title mb-0">Total People</div>
                        <small class="opacity-75">
                            <i class="fas fa-users me-1"></i>
                            Registered users
                        </small>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-users fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Summary -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card chart-container">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Real-time Status Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="statusChart" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex flex-column justify-content-center h-100">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="fw-600">Safe Rate</span>
                                        <span class="text-success fw-bold">{{ ((stats.safe / stats.total * 100) | round(1)) if stats.total > 0 else 0 }}%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" style="width: {{ ((stats.safe / stats.total * 100)) if stats.total > 0 else 0 }}%"></div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="fw-600">Response Rate</span>
                                        <span class="text-info fw-bold">{{ (((stats.safe + stats.stuck) / stats.total * 100) | round(1)) if stats.total > 0 else 0 }}%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-info" style="width: {{ (((stats.safe + stats.stuck) / stats.total * 100)) if stats.total > 0 else 0 }}%"></div>
                                    </div>
                                </div>
                                <div class="alert alert-info small mb-0">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Last updated: <span id="lastUpdate">Just now</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Needs Immediate Attention
                    </h6>
                </div>
                <div class="card-body">
                    {% if checkins %}
                    {% set stuck_checkins = checkins | selectattr('status', 'equalto', 'stuck') | list %}
                    {% if stuck_checkins %}
                    <div class="list-group list-group-flush">
                        {% for checkin in stuck_checkins[:5] %}
                        <div class="list-group-item d-flex justify-content-between align-items-start p-2">
                            <div class="flex-grow-1">
                                <div class="fw-600">{{ checkin.user.name if checkin.user else 'Unknown' }}</div>
                                <small class="text-muted">{{ checkin.location or 'Location unknown' }}</small>
                                {% if checkin.message %}
                                <div class="small text-warning mt-1">{{ checkin.message[:50] }}...</div>
                                {% endif %}
                            </div>
                            <button class="btn btn-outline-warning btn-sm ms-2" title="Contact">
                                <i class="fas fa-phone"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <p class="text-muted mb-0">All users are safe</p>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No check-ins yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label fw-600">Search Users</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search by name, location...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-600">Filter by Status</label>
                            <select class="form-select" id="statusFilter" onchange="filterCheckins()">
                                <option value="">All Status</option>
                                <option value="safe">Safe</option>
                                <option value="stuck">Stuck</option>
                                <option value="unknown">No Response</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-600">Time Period</label>
                            <select class="form-select" id="timeFilter">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary w-100" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="fw-bold mb-3">Quick Actions</h6>
                    <div class="btn-group w-100" role="group">
                        <button class="btn btn-success" onclick="quickCheckin('safe')" title="Mark as Safe">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-warning" onclick="quickCheckin('stuck')" title="Mark as Stuck">
                            <i class="fas fa-exclamation"></i>
                        </button>
                        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#sendMessageModal" title="Send Message">
                            <i class="fas fa-comment"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Check-ins Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-custom">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Check-in Records
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="viewMode('list')">
                            <i class="fas fa-list"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="viewMode('grid')">
                            <i class="fas fa-th"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if checkins %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>User</th>
                                    <th>Status</th>
                                    <th>Location</th>
                                    <th>Message</th>
                                    <th>Check-in Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="checkinsTableBody">
                                {% for checkin in checkins %}
                                <tr class="checkin-row" data-status="{{ checkin.status }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle me-2
                                                {% if checkin.status == 'safe' %}bg-success
                                                {% elif checkin.status == 'stuck' %}bg-warning
                                                {% else %}bg-secondary{% endif %}">
                                                {{ checkin.user.name[0] if checkin.user and checkin.user.name else '?' }}
                                            </div>
                                            <div>
                                                <div class="fw-600">{{ checkin.user.name if checkin.user else 'Unknown User' }}</div>
                                                <small class="text-muted">{{ checkin.user.role.title() if checkin.user and checkin.user.role else 'Unknown Role' }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if checkin.status == 'safe' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Safe
                                        </span>
                                        {% elif checkin.status == 'stuck' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-exclamation me-1"></i>Stuck
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-question me-1"></i>Unknown
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="fw-600">{{ checkin.location or 'Not specified' }}</div>
                                        {% if checkin.incident %}
                                        <small class="text-muted">Incident #{{ checkin.incident.id }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if checkin.message %}
                                        <span class="text-truncate d-inline-block" style="max-width: 200px;" 
                                              title="{{ checkin.message }}">
                                            {{ checkin.message }}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">No message</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="fw-600">{{ checkin.created_at.strftime('%Y-%m-%d') if checkin.created_at else 'Unknown' }}</div>
                                        <small class="text-muted">{{ checkin.created_at.strftime('%H:%M:%S') if checkin.created_at else '' }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% if checkin.status == 'stuck' %}
                                            <button class="btn btn-outline-warning" title="Contact User">
                                                <i class="fas fa-phone"></i>
                                            </button>
                                            <button class="btn btn-outline-info" title="Send Message">
                                                <i class="fas fa-comment"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-outline-primary" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">No check-ins recorded</h5>
                        <p class="text-muted mb-4">No safety check-ins have been recorded yet</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkCheckinModal">
                            <i class="fas fa-users-cog me-2"></i>Start Bulk Check-in
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Check-in Modal -->
<div class="modal fade" id="bulkCheckinModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-users-cog me-2"></i>Bulk Safety Check-in
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This will send check-in requests to all registered users via SMS and push notifications.
                </div>
                <form id="bulkCheckinForm">
                    <div class="mb-3">
                        <label class="form-label">Check-in Message</label>
                        <textarea class="form-control" name="message" rows="3" 
                                  placeholder="Please confirm your safety status...">Please confirm your current safety status. Respond with your location if you need assistance.</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Groups</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="students" checked>
                            <label class="form-check-label" for="students">Students</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="staff" checked>
                            <label class="form-check-label" for="staff">Staff</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="visitors">
                            <label class="form-check-label" for="visitors">Visitors</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="sendBulkCheckin()">
                    <i class="fas fa-paper-plane me-2"></i>Send Check-in Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Send Message Modal -->
<div class="modal fade" id="sendMessageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-comment me-2"></i>Send Safety Message
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="messageForm">
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" name="message" rows="3" 
                                  placeholder="Enter your safety message..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Send To</label>
                        <select class="form-select" name="recipients" required>
                            <option value="">Select recipients...</option>
                            <option value="all">All Users</option>
                            <option value="stuck">Users Marked as Stuck</option>
                            <option value="no_response">Users with No Response</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendMessage()">
                    <i class="fas fa-send me-2"></i>Send Message
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-circle {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
}
</style>

<script>
// Initialize status chart
document.addEventListener('DOMContentLoaded', function() {
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Safe', 'Stuck', 'No Response'],
                datasets: [{
                    data: [{{ stats.safe }}, {{ stats.stuck }}, {{ stats.unknown }}],
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
});

// Filter check-ins
function filterCheckins() {
    const status = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('.checkin-row');
    
    rows.forEach(row => {
        if (!status || row.dataset.status === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.checkin-row');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Send bulk check-in
function sendBulkCheckin() {
    showAlert('Bulk check-in request sent to all users!', 'success');
    bootstrap.Modal.getInstance(document.getElementById('bulkCheckinModal')).hide();
}

// Send message
function sendMessage() {
    const form = document.getElementById('messageForm');
    const formData = new FormData(form);
    
    if (!formData.get('message') || !formData.get('recipients')) {
        showAlert('Please fill in all fields', 'warning');
        return;
    }
    
    showAlert('Safety message sent successfully!', 'success');
    bootstrap.Modal.getInstance(document.getElementById('sendMessageModal')).hide();
    form.reset();
}

// Refresh data
function refreshData() {
    showAlert('Data refreshed', 'info');
    // In a real app, this would reload the data
}

// View mode toggle
function viewMode(mode) {
    // Toggle between list and grid view
    console.log('Switching to', mode, 'view');
}

// Update timestamp
setInterval(function() {
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
}, 1000);
</script>
{% endblock %}
