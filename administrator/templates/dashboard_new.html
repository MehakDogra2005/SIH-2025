{% extends "base_new.html" %}

{% block title %}Dashboard - Emergency Management System{% endblock %}
{% block page_title %}Welcome back, {{ user.name.split()[0] }}!{% endblock %}

{% block content %}
<!-- Emergency Alert Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="emergency-alert-section">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center">
                        <div class="emergency-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div>
                            <h4 class="mb-1 text-white">Emergency Response Center</h4>
                            <p class="mb-0 text-white-50">Report incidents immediately • Get help when you need it</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-danger btn-lg emergency-btn" onclick="reportEmergency()">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        REPORT EMERGENCY
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Status Banner -->
<div class="row mb-4">
    <div class="col-12">
        <div class="status-banner">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <div class="status-indicator status-normal me-3"></div>
                        <div>
                            <h5 class="mb-0 text-dark">System Status: <span class="text-success fw-bold">All Clear</span></h5>
                            <small class="text-muted">Last updated: Just now</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-4 justify-content-md-end">
                        <div class="status-item-inline">
                            <i class="fas fa-shield-alt text-success me-1"></i>
                            <span class="text-dark">Security: Active</span>
                        </div>
                        <div class="status-item-inline">
                            <i class="fas fa-users text-primary me-1"></i>
                            <span class="text-dark">{{ stats.safe_checkins + stats.stuck_checkins }} Online</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Dashboard Content -->

<!-- Key Metrics Cards - Full Width Row -->
<div class="section-header">
    <h5><i class="fas fa-chart-bar me-2"></i>Key Metrics</h5>
</div>
<div class="row mb-4">
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="metric-card metric-primary">
            <div class="metric-content">
                <div class="metric-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="metric-data">
                    <h3>{{ stats.total_incidents }}</h3>
                    <p>Total Incidents</p>
                    <span class="metric-change">
                        <i class="fas fa-arrow-up"></i> +3 this week
                    </span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="metric-card metric-warning">
            <div class="metric-content">
                <div class="metric-icon">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="metric-data">
                    <h3>{{ stats.active_incidents }}</h3>
                    <p>Active Alerts</p>
                    <span class="metric-change">
                        {% if stats.active_incidents > 0 %}
                        <i class="fas fa-exclamation-circle"></i> Needs attention
                        {% else %}
                        <i class="fas fa-check-circle"></i> All clear
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="metric-card metric-success">
            <div class="metric-content">
                <div class="metric-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="metric-data">
                    <h3>{{ stats.safe_checkins }}</h3>
                    <p>Safe Personnel</p>
                    <span class="metric-change">
                        <i class="fas fa-shield-alt"></i> {{ ((stats.safe_checkins / (stats.safe_checkins + stats.stuck_checkins + 1)) * 100)|round }}% secured
                    </span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="metric-card metric-info">
            <div class="metric-content">
                <div class="metric-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="metric-data">
                    <h3>{{ stats.preparedness_score|round }}%</h3>
                    <p>Preparedness Score</p>
                    <span class="metric-change">
                        <i class="fas fa-trending-up"></i> +5% this month
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Second Row: Live Updates and Student Status -->
<div class="row mb-4">
    <!-- Live Updates -->
    <div class="col-lg-6">
        <div class="dashboard-card h-100">
            <div class="card-header">
                <h6><i class="fas fa-bell me-2"></i>Live Updates</h6>
                <span class="notification-badge">{{ recent_notifications|length if recent_notifications else 3 }}</span>
            </div>
            <div class="card-body">
                {% if recent_notifications %}
                    {% for notification in recent_notifications[:4] %}
                    <div class="notification-item">
                        <div class="notification-icon">
                            <i class="fas fa-{% if notification.type == 'alert' %}exclamation-triangle{% elif notification.type == 'drill' %}users-cog{% else %}info-circle{% endif %}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-title">{{ notification.title }}</div>
                            <div class="notification-text">{{ notification.message|truncate(80) }}</div>
                            <div class="notification-time">
                                <i class="fas fa-clock me-1"></i>{{ notification.created_at.strftime('%H:%M') }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="notification-item">
                    <div class="notification-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">Weather Alert</div>
                        <div class="notification-text">Heavy rainfall expected in your region today</div>
                        <div class="notification-time">
                            <i class="fas fa-clock me-1"></i>10 min ago
                        </div>
                    </div>
                </div>
                <div class="notification-item">
                    <div class="notification-icon">
                        <i class="fas fa-users-cog"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">Drill Scheduled</div>
                        <div class="notification-text">Fire evacuation drill tomorrow at 11:00 AM</div>
                        <div class="notification-time">
                            <i class="fas fa-clock me-1"></i>2 hours ago
                        </div>
                    </div>
                </div>
                <div class="notification-item">
                    <div class="notification-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">System Update</div>
                        <div class="notification-text">Emergency protocols updated successfully</div>
                        <div class="notification-time">
                            <i class="fas fa-clock me-1"></i>1 day ago
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Student Status Overview -->
    <div class="col-lg-6">
        <div class="dashboard-card h-100">
            <div class="card-header">
                <h6><i class="fas fa-users me-2"></i>Student Status Overview</h6>
            </div>
            <div class="card-body">
                <div class="student-stats">
                    <div class="stat-item rescued">
                        <div class="stat-icon">
                            <i class="fas fa-hand-holding-heart"></i>
                        </div>
                        <div class="stat-details">
                            <h4>{{ stats.rescued_students or 0 }}</h4>
                            <p>Students Rescued</p>
                        </div>
                    </div>
                    <div class="stat-item learning">
                        <div class="stat-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="stat-details">
                            <h4>{{ stats.learning_students or 0 }}</h4>
                            <p>Continuing Learning</p>
                        </div>
                    </div>
                    <div class="stat-item safe">
                        <div class="stat-icon">
                            <i class="fas fa-shield-check"></i>
                        </div>
                        <div class="stat-details">
                            <h4>{{ stats.safe_students or 0 }}</h4>
                            <p>Confirmed Safe</p>
                        </div>
                    </div>
                </div>
                <div class="progress-section mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Overall Safety Status</span>
                        <span class="fw-bold">{{ ((stats.safe_students or 0) / (stats.total_students or 1) * 100)|round }}%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ ((stats.safe_students or 0) / (stats.total_students or 1) * 100)|round }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Third Row: Recent Activity and Emergency Actions -->
<div class="row">
    <!-- Recent Activity -->
    <div class="col-lg-6">
        {% if recent_incidents %}
        <div class="dashboard-card h-100">
            <div class="card-header">
                <h6><i class="fas fa-history me-2"></i>Recent Activity</h6>
                <a href="{{ url_for('incidents') }}" class="btn btn-outline-primary btn-sm">View All</a>
            </div>
            <div class="card-body">
                <div class="activity-list">
                    {% for incident in recent_incidents[:4] %}
                    <div class="activity-item">
                        <div class="activity-icon activity-{{ incident.type }}">
                            <i class="fas fa-{% if incident.type == 'fire' %}fire{% elif incident.type == 'flood' %}water{% elif incident.type == 'earthquake' %}mountain{% else %}exclamation-triangle{% endif %}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">{{ incident.type.title() }} incident reported</div>
                            <div class="activity-subtitle">{{ incident.location }} • {{ incident.created_at.strftime('%H:%M') }}</div>
                        </div>
                        <div class="activity-status">
                            <span class="status-badge status-{{ incident.status }}">{{ incident.status.title() }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="dashboard-card h-100">
            <div class="card-header">
                <h6><i class="fas fa-heartbeat me-2"></i>System Health</h6>
            </div>
            <div class="card-body">
                <div class="health-status-list">
                    <div class="health-item">
                        <div class="health-indicator health-good"></div>
                        <div class="health-details">
                            <span class="health-name">Emergency Services</span>
                            <span class="health-value">Online</span>
                        </div>
                    </div>
                    <div class="health-item">
                        <div class="health-indicator health-good"></div>
                        <div class="health-details">
                            <span class="health-name">Communication Network</span>
                            <span class="health-value">Strong</span>
                        </div>
                    </div>
                    <div class="health-item">
                        <div class="health-indicator health-warning"></div>
                        <div class="health-details">
                            <span class="health-name">Weather Monitoring</span>
                            <span class="health-value">Alert Active</span>
                        </div>
                    </div>
                    <div class="health-item">
                        <div class="health-indicator health-good"></div>
                        <div class="health-details">
                            <span class="health-name">Database Connection</span>
                            <span class="health-value">Stable</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Emergency Actions -->
    <div class="col-lg-6">
        <div class="dashboard-card h-100">
            <div class="card-header">
                <h6><i class="fas fa-shield-alt me-2"></i>Emergency Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <button class="btn btn-primary btn-lg" onclick="openPDFReportModal()">
                        <i class="fas fa-file-pdf me-2"></i>
                        Send Report to NDMA
                    </button>
                    <button class="btn btn-success btn-lg" onclick="openGuardianMessageModal()">
                        <i class="fas fa-comment-medical me-2"></i>
                        Send Messages to Guardians
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<style>
/* Emergency Alert Section */
.emergency-alert-section {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    border-radius: 16px;
    padding: 2rem;
    color: white;
    box-shadow: 0 8px 32px rgba(220, 38, 38, 0.3);
}

.emergency-icon {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-right: 1rem;
    animation: pulse-emergency 2s infinite;
}

@keyframes pulse-emergency {
    0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
}

.emergency-btn {
    font-weight: 600;
    padding: 12px 24px;
    border-radius: 8px;
    border: 2px solid white;
    background: white;
    color: #dc2626;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.emergency-btn:hover {
    background: transparent;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
}

/* Status Banner */
.status-banner {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #10b981;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.status-normal { background: #10b981; }
.status-warning { background: #f59e0b; }
.status-danger { background: #ef4444; }

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}

.status-item-inline {
    font-size: 0.9rem;
}

/* Section Headers */
.section-header {
    margin-bottom: 1.5rem;
}

.section-header h5 {
    color: var(--text-dark);
    font-weight: 600;
    margin: 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--primary);
    display: inline-block;
}

/* Quick Actions */
.quick-actions-section {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
}

.action-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.5rem 1rem;
    border-radius: 12px;
    text-decoration: none;
    color: white;
    border: none;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
    height: 100%;
    min-height: 120px;
}

.action-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    color: white;
}

.action-icon {
    font-size: 2rem;
    margin-bottom: 0.75rem;
}

.action-label {
    font-size: 0.9rem;
    text-align: center;
    line-height: 1.3;
}

.action-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
.action-success { background: linear-gradient(135deg, #10b981, #059669); }
.action-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
.action-info { background: linear-gradient(135deg, #06b6d4, #0891b2); }
.action-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
.action-secondary { background: linear-gradient(135deg, #6b7280, #4b5563); }

/* Metric Cards */
.metric-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border-left: 4px solid;
    transition: all 0.3s ease;
    height: 100%;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.metric-primary { border-left-color: var(--primary); }
.metric-warning { border-left-color: #f59e0b; }
.metric-success { border-left-color: #10b981; }
.metric-info { border-left-color: #06b6d4; }

.metric-content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.metric-icon {
    background: #f1f5f9;
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--primary);
}

.metric-data h3 {
    font-size: 1.8rem;
    font-weight: 700;
    margin: 0;
    color: var(--text-dark);
}

.metric-data p {
    margin: 0;
    color: #6b7280;
    font-weight: 500;
}

.metric-change {
    font-size: 0.8rem;
    color: #10b981;
    font-weight: 500;
}

/* Dashboard Cards */
.dashboard-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    height: fit-content;
}

.card-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #f8fafc;
}

.card-header h6 {
    margin: 0;
    font-weight: 600;
    color: var(--text-dark);
}

.card-body {
    padding: 1.5rem;
}

/* Health Status */
.health-status-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.health-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 8px;
}

.health-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.health-good { background: #10b981; }
.health-warning { background: #f59e0b; }
.health-danger { background: #ef4444; }

.health-details {
    display: flex;
    justify-content: space-between;
    width: 100%;
}

.health-name {
    font-weight: 500;
    color: var(--text-dark);
}

.health-value {
    font-size: 0.9rem;
    color: #6b7280;
}

/* Activity Items */
.activity-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
}

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.activity-fire { background: linear-gradient(135deg, #ef4444, #dc2626); }
.activity-flood { background: linear-gradient(135deg, #06b6d4, #0891b2); }
.activity-earthquake { background: linear-gradient(135deg, #f59e0b, #d97706); }
.activity-other { background: linear-gradient(135deg, #6b7280, #4b5563); }

.activity-content {
    flex: 1;
}

.activity-title {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
}

.activity-subtitle {
    font-size: 0.9rem;
    color: #6b7280;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-open { background: #fef3c7; color: #92400e; }
.status-resolved { background: #d1fae5; color: #065f46; }
.status-assigned { background: #dbeafe; color: #1e40af; }

/* Notification Items */
.notification-badge {
    background: var(--primary);
    color: white;
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
}

.notification-item {
    display: flex;
    gap: 1rem;
    padding: 1rem 0;
    border-bottom: 1px solid #f1f5f9;
}

.notification-item:last-child {
    border-bottom: none;
}

.notification-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    flex-shrink: 0;
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
}

.notification-text {
    font-size: 0.9rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.notification-time {
    font-size: 0.8rem;
    color: #9ca3af;
}

/* Contact Items */
.contact-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.contact-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
}

.contact-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.contact-fire { background: linear-gradient(135deg, #ef4444, #dc2626); }
.contact-police { background: linear-gradient(135deg, #06b6d4, #0891b2); }
.contact-medical { background: linear-gradient(135deg, #10b981, #059669); }

.contact-details {
    flex: 1;
}

.contact-name {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
}

.contact-number {
    font-size: 0.9rem;
    color: #6b7280;
    font-weight: 500;
}

/* Student Status */
.student-stats {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.stat-item.rescued {
    background: linear-gradient(135deg, #fef3c7, #fcd34d);
    border-left: 4px solid #f59e0b;
}

.stat-item.learning {
    background: linear-gradient(135deg, #dbeafe, #93c5fd);
    border-left: 4px solid #3b82f6;
}

.stat-item.safe {
    background: linear-gradient(135deg, #d1fae5, #86efac);
    border-left: 4px solid #10b981;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.stat-item.rescued .stat-icon {
    background: #f59e0b;
}

.stat-item.learning .stat-icon {
    background: #3b82f6;
}

.stat-item.safe .stat-icon {
    background: #10b981;
}

.stat-details h4 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    color: var(--text-dark);
}

.stat-details p {
    margin: 0;
    font-size: 0.9rem;
    color: #6b7280;
    font-weight: 500;
}

.progress-section {
    padding-top: 1rem;
    border-top: 1px solid #f1f5f9;
}

/* Emergency Actions */
.dashboard-card .btn-lg {
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.dashboard-card .btn-lg:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Responsive */
@media (max-width: 768px) {
    .emergency-alert-section, .quick-actions-section {
        padding: 1.5rem;
    }
    
    .metric-content {
        flex-direction: column;
        text-align: center;
    }
    
    .action-card {
        min-height: 100px;
    }
    
    .action-icon {
        font-size: 1.5rem;
    }
}

/* PDF Report Modal Styles */
.pdf-preview-container {
    max-height: 70vh;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
    padding: 1rem;
}

.pdf-document {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    max-width: 100%;
}

.pdf-header {
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
}

.pdf-content .section {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
    border-left: 4px solid var(--primary);
}

.stat-box {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    margin-bottom: 0.5rem;
}

.safety-stat {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.safety-stat.rescued {
    border-left: 4px solid #f59e0b;
}

.safety-stat.learning {
    border-left: 4px solid #3b82f6;
}

.safety-stat.safe {
    border-left: 4px solid #10b981;
}

.edit-panel {
    background: #f8fafc;
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    height: fit-content;
}

/* Guardian Message Modal Styles */
.safety-overview {
    background: #f8fafc;
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.status-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    text-align: center;
    margin-bottom: 1rem;
}

.safe-card {
    border-left: 4px solid #10b981;
}

.alert-card {
    border-left: 4px solid #f59e0b;
}

.status-card h4 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
}

.status-card.safe-card h4 {
    color: #10b981;
}

.status-card.alert-card h4 {
    color: #f59e0b;
}

.status-card p {
    margin: 0.5rem 0 0 0;
    color: #6b7280;
    font-weight: 500;
}

.student-alert-item {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
}

.message-options {
    background: #f8fafc;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.form-check {
    margin-bottom: 0.5rem;
}

.form-check:last-child {
    margin-bottom: 0;
}

/* Modern Emergency Modal Styles */
.emergency-modal-size {
    max-width: 600px;
    width: 90%;
}

.modern-emergency-modal {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    border: none;
}

.emergency-header {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    padding: 1.25rem 1.5rem;
    border-bottom: none;
}

.emergency-header .modal-title {
    font-size: 1.1rem;
    font-weight: 600;
}

.modal-body {
    padding: 1.5rem;
    max-height: 70vh;
    overflow-y: auto;
}

.emergency-footer {
    background: #f8fafc;
    border-top: 1px solid #e5e7eb;
    padding: 1rem 1.5rem;
}

.emergency-tabs {
    display: flex;
    background: #f1f5f9;
    border-radius: 10px;
    padding: 3px;
    margin-bottom: 1.5rem;
}

.tab-btn {
    flex: 1;
    padding: 10px 16px;
    border: none;
    background: transparent;
    border-radius: 7px;
    font-weight: 600;
    color: #64748b;
    transition: all 0.3s ease;
    cursor: pointer;
    font-size: 0.9rem;
}

.tab-btn.active {
    background: white;
    color: #dc2626;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.emergency-categories {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 1.25rem;
}

.emergency-category {
    padding: 0.875rem;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    position: relative;
    overflow: hidden;
    min-height: 110px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.emergency-category::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(220, 38, 38, 0.1), transparent);
    transition: left 0.5s ease;
}

.emergency-category:hover::before {
    left: 100%;
}

.emergency-category:hover {
    border-color: #dc2626;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(220, 38, 38, 0.15);
}

.emergency-category.selected {
    border-color: #dc2626;
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
    transform: scale(1.02);
}

.category-icon {
    width: 42px;
    height: 42px;
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    margin: 0 auto 0.6rem;
    transition: all 0.3s ease;
}

.emergency-category:hover .category-icon {
    transform: scale(1.05);
}

.emergency-category h6 {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
    font-size: 0.85rem;
    line-height: 1.2;
}

.emergency-category p {
    font-size: 0.75rem;
    color: #6b7280;
    margin: 0;
    line-height: 1.2;
}

.severity-selection {
    background: #f8fafc;
    padding: 1.25rem;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
}

.severity-buttons {
    display: flex;
    gap: 8px;
    margin-top: 0.875rem;
}

.severity-btn {
    flex: 1;
    padding: 10px 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    min-height: 70px;
}

.severity-btn:hover {
    border-color: #dc2626;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
}

.severity-btn.selected {
    border-color: #dc2626;
    background: #fef2f2;
}

.severity-btn i {
    font-size: 1.1rem;
}

.severity-btn span {
    font-weight: 600;
    font-size: 0.85rem;
}

.location-section, .description-section {
    background: #f8fafc;
    padding: 1.25rem;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
}

.location-section .form-label, .description-section .form-label {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
}

.location-section .form-control, .description-section .form-control {
    border-radius: 8px;
    border: 1px solid #d1d5db;
    padding: 0.75rem;
}

/* Voice Recognition Styles */
.voice-recognition {
    text-align: center;
    padding: 1.5rem;
    background: #f8fafc;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
}

.voice-status {
    font-size: 1rem;
    margin: 0.875rem 0;
    color: #374151;
    min-height: 24px;
    font-weight: 500;
}

.voice-button {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    margin: 0.875rem auto;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(220, 38, 38, 0.25);
}

.voice-button.listening {
    background: linear-gradient(135deg, #10b981, #059669);
    animation: pulse-voice 1.5s infinite;
}

.voice-button:hover {
    transform: scale(1.05);
}

.voice-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

@keyframes pulse-voice {
    0% {
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.25);
    }
    50% {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.25);
    }
}

.voice-transcript {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    padding: 1.25rem;
    margin: 1.25rem 0;
    min-height: 100px;
    text-align: left;
}

.voice-transcript-text {
    font-size: 0.9rem;
    color: #374151;
    line-height: 1.5;
    min-height: 60px;
}

.voice-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 1.25rem;
}

.alert-btn {
    padding: 8px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    background: white;
    color: #374151;
    font-size: 0.9rem;
}

.alert-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.alert-btn.primary {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: white;
    border-color: #dc2626;
}

.alert-btn.primary:hover {
    background: linear-gradient(135deg, #b91c1c, #991b1b);
}

/* Footer buttons */
.emergency-footer .btn {
    padding: 0.75rem 1.25rem;
    font-size: 0.9rem;
    font-weight: 600;
    border-radius: 8px;
}

.emergency-footer .btn-danger {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    border: none;
}

.emergency-footer .btn-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    border: none;
}

/* Responsive Design */
@media (max-width: 768px) {
    .emergency-modal-size {
        width: 95%;
        max-width: none;
        margin: 0.5rem;
    }
    
    .modern-emergency-modal {
        margin: 0;
    }
    
    .modal-body {
        padding: 1rem;
        max-height: 75vh;
    }
    
    .emergency-header {
        padding: 1rem 1.25rem;
    }
    
    .emergency-footer {
        padding: 0.875rem 1.25rem;
    }
    
    .emergency-categories {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    
    .emergency-category {
        padding: 0.75rem;
        min-height: 95px;
    }
    
    .category-icon {
        width: 36px;
        height: 36px;
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .emergency-category h6 {
        font-size: 0.8rem;
        margin-bottom: 0.2rem;
    }
    
    .emergency-category p {
        font-size: 0.7rem;
    }
    
    .severity-buttons {
        flex-wrap: wrap;
        gap: 6px;
    }
    
    .severity-btn {
        flex: 1 1 calc(50% - 3px);
        min-width: 0;
        padding: 8px 10px;
        min-height: 60px;
    }
    
    .severity-btn span {
        font-size: 0.8rem;
    }
    
    .voice-button {
        width: 70px;
        height: 70px;
        font-size: 1.3rem;
    }
    
    .emergency-tabs {
        flex-direction: column;
        gap: 2px;
    }
    
    .tab-btn {
        padding: 8px 12px;
        font-size: 0.85rem;
    }
    
    .location-section, .description-section, .severity-selection, .voice-recognition {
        padding: 1rem;
    }
    
    .emergency-footer .btn {
        padding: 0.625rem 1rem;
        font-size: 0.85rem;
    }
}

@media (max-width: 480px) {
    .emergency-modal-size {
        width: 98%;
        margin: 0.25rem;
    }
    
    .emergency-categories {
        grid-template-columns: 1fr;
        gap: 6px;
    }
    
    .emergency-category {
        padding: 0.875rem;
        min-height: 80px;
        flex-direction: row;
        text-align: left;
        align-items: center;
        gap: 0.75rem;
    }
    
    .category-icon {
        margin: 0;
        flex-shrink: 0;
    }
    
    .severity-buttons {
        flex-direction: column;
        gap: 6px;
    }
    
    .severity-btn {
        flex-direction: row;
        justify-content: center;
        gap: 8px;
        min-height: 50px;
    }
    
    .emergency-footer {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .emergency-footer .btn {
        width: 100%;
    }
}
</style>

<script>
// Emergency Report Function
function reportEmergency() {
    const modal = new bootstrap.Modal(document.getElementById('emergencyModal') || createEmergencyModal());
    modal.show();
}

function createEmergencyModal() {
    const modalHtml = `
        <div class="modal fade" id="emergencyModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered emergency-modal-size">
                <div class="modal-content modern-emergency-modal">
                    <div class="modal-header emergency-header">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle me-2"></i>Emergency Reporting System
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="emergency-tabs">
                            <button class="tab-btn active" data-tab="quick">Quick Report</button>
                            <button class="tab-btn" data-tab="voice">Voice Report</button>
                            <button class="tab-btn" data-tab="detailed">Detailed Report</button>
                        </div>
                        
                        <!-- Quick Report Tab -->
                        <div class="tab-content active" id="quickTab">
                            <div class="emergency-categories">
                                <div class="emergency-category" data-type="fire">
                                    <div class="category-icon">
                                        <i class="fas fa-fire"></i>
                                    </div>
                                    <h6>Fire Emergency</h6>
                                    <p>Building fire, smoke, flames</p>
                                </div>
                                <div class="emergency-category" data-type="flood">
                                    <div class="category-icon">
                                        <i class="fas fa-water"></i>
                                    </div>
                                    <h6>Flood/Water</h6>
                                    <p>Flooding, water damage</p>
                                </div>
                                <div class="emergency-category" data-type="earthquake">
                                    <div class="category-icon">
                                        <i class="fas fa-mountain"></i>
                                    </div>
                                    <h6>Earthquake</h6>
                                    <p>Ground shaking, structural damage</p>
                                </div>
                                <div class="emergency-category" data-type="medical">
                                    <div class="category-icon">
                                        <i class="fas fa-heart-pulse"></i>
                                    </div>
                                    <h6>Medical Emergency</h6>
                                    <p>Injury, illness, health crisis</p>
                                </div>
                                <div class="emergency-category" data-type="security">
                                    <div class="category-icon">
                                        <i class="fas fa-shield-exclamation"></i>
                                    </div>
                                    <h6>Security Threat</h6>
                                    <p>Intruder, violence, threat</p>
                                </div>
                                <div class="emergency-category" data-type="other">
                                    <div class="category-icon">
                                        <i class="fas fa-exclamation"></i>
                                    </div>
                                    <h6>Other Emergency</h6>
                                    <p>Other critical situation</p>
                                </div>
                            </div>
                            
                            <div class="severity-selection mt-4">
                                <label class="form-label fw-bold">Severity Level</label>
                                <div class="severity-buttons">
                                    <button class="severity-btn" data-severity="low">
                                        <i class="fas fa-circle text-success"></i>
                                        <span>Low</span>
                                    </button>
                                    <button class="severity-btn" data-severity="medium">
                                        <i class="fas fa-circle text-warning"></i>
                                        <span>Medium</span>
                                    </button>
                                    <button class="severity-btn" data-severity="high">
                                        <i class="fas fa-circle text-danger"></i>
                                        <span>High</span>
                                    </button>
                                    <button class="severity-btn" data-severity="critical">
                                        <i class="fas fa-circle text-dark"></i>
                                        <span>Critical</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="location-section mt-4">
                                <label class="form-label fw-bold">Location</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="quickLocation" placeholder="Enter specific location...">
                                    <button class="btn btn-outline-primary" type="button" onclick="getCurrentLocation()">
                                        <i class="fas fa-map-marker-alt me-1"></i>Use Current Location
                                    </button>
                                </div>
                            </div>
                            
                            <div class="description-section mt-4">
                                <label class="form-label fw-bold">Quick Description</label>
                                <textarea class="form-control" id="quickDescription" rows="3" placeholder="Brief description of the emergency..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Voice Report Tab -->
                        <div class="tab-content" id="voiceTab">
                            <div class="voice-recognition">
                                <div class="voice-status" id="voiceStatus">Click the microphone to start voice reporting</div>
                                <button class="voice-button" id="voiceButton">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <div class="voice-transcript" id="voiceTranscript">
                                    <div class="voice-transcript-text" id="transcriptText">Voice transcript will appear here...</div>
                                </div>
                                <div class="voice-actions">
                                    <button class="alert-btn" id="clearTranscript">Clear</button>
                                    <button class="alert-btn primary" id="processVoiceReport">Process Report</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detailed Report Tab -->
                        <div class="tab-content" id="detailedTab">
                            <form id="detailedEmergencyForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Emergency Type</label>
                                        <select class="form-select" name="emergency_type" required>
                                            <option value="">Select Emergency Type</option>
                                            <option value="fire">Fire</option>
                                            <option value="flood">Flood</option>
                                            <option value="earthquake">Earthquake</option>
                                            <option value="medical">Medical Emergency</option>
                                            <option value="security">Security Threat</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Severity Level</label>
                                        <select class="form-select" name="severity" required>
                                            <option value="">Select Severity</option>
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                            <option value="critical">Critical</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Location</label>
                                    <input type="text" class="form-control" name="location" placeholder="Exact location of emergency" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Description</label>
                                    <textarea class="form-control" name="description" rows="4" placeholder="Describe the emergency situation in detail..." required></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Your Name</label>
                                        <input type="text" class="form-control" name="reporter_name" placeholder="Your full name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Contact Number</label>
                                        <input type="tel" class="form-control" name="contact_number" placeholder="Your contact number" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Additional Information</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="injuredPersons">
                                        <label class="form-check-label" for="injuredPersons">
                                            People injured or trapped
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="evacuationNeeded">
                                        <label class="form-check-label" for="evacuationNeeded">
                                            Evacuation required
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="utilitiesAffected">
                                        <label class="form-check-label" for="utilitiesAffected">
                                            Utilities affected (power, gas, water)
                                        </label>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="modal-footer emergency-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" onclick="alertEmergencyServices()">
                            <i class="fas fa-phone me-2"></i>Call Emergency Services
                        </button>
                        <button type="button" class="btn btn-danger" onclick="submitEmergencyReport()">
                            <i class="fas fa-exclamation-triangle me-2"></i>Submit Emergency Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Initialize modal functionality
    initializeEmergencyModal();
    
    return document.getElementById('emergencyModal');
}

// Initialize Emergency Modal Functionality
function initializeEmergencyModal() {
    // Tab switching
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetTab = btn.dataset.tab;
            
            // Update active tab button
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Update active tab content
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === targetTab + 'Tab') {
                    content.classList.add('active');
                }
            });
        });
    });
    
    // Emergency category selection
    const categories = document.querySelectorAll('.emergency-category');
    categories.forEach(category => {
        category.addEventListener('click', () => {
            categories.forEach(c => c.classList.remove('selected'));
            category.classList.add('selected');
        });
    });
    
    // Severity selection
    const severityBtns = document.querySelectorAll('.severity-btn');
    severityBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            severityBtns.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        });
    });
    
    // Voice recognition
    initializeVoiceRecognition();
}

// Voice Recognition Implementation
let recognition;
let isListening = false;

function initializeVoiceRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        
        const voiceButton = document.getElementById('voiceButton');
        const voiceStatus = document.getElementById('voiceStatus');
        const transcriptText = document.getElementById('transcriptText');
        const clearButton = document.getElementById('clearTranscript');
        const processButton = document.getElementById('processVoiceReport');
        
        if (voiceButton) {
            voiceButton.addEventListener('click', toggleVoiceRecognition);
        }
        
        if (clearButton) {
            clearButton.addEventListener('click', () => {
                transcriptText.textContent = 'Voice transcript will appear here...';
            });
        }
        
        if (processButton) {
            processButton.addEventListener('click', processVoiceReport);
        }
        
        recognition.onstart = () => {
            isListening = true;
            voiceButton.classList.add('listening');
            voiceStatus.textContent = 'Listening... Speak clearly about the emergency';
        };
        
        recognition.onresult = (event) => {
            let finalTranscript = '';
            let interimTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                } else {
                    interimTranscript += transcript;
                }
            }
            
            transcriptText.textContent = finalTranscript + interimTranscript;
        };
        
        recognition.onerror = (event) => {
            voiceStatus.textContent = 'Error: ' + event.error;
            stopVoiceRecognition();
        };
        
        recognition.onend = () => {
            stopVoiceRecognition();
        };
    } else {
        const voiceStatus = document.getElementById('voiceStatus');
        if (voiceStatus) {
            voiceStatus.textContent = 'Voice recognition not supported in this browser';
        }
    }
}

function toggleVoiceRecognition() {
    if (isListening) {
        stopVoiceRecognition();
    } else {
        startVoiceRecognition();
    }
}

function startVoiceRecognition() {
    if (recognition) {
        recognition.start();
    }
}

function stopVoiceRecognition() {
    if (recognition) {
        recognition.stop();
    }
    isListening = false;
    const voiceButton = document.getElementById('voiceButton');
    const voiceStatus = document.getElementById('voiceStatus');
    
    if (voiceButton) {
        voiceButton.classList.remove('listening');
    }
    if (voiceStatus) {
        voiceStatus.textContent = 'Click the microphone to start voice reporting';
    }
}

function processVoiceReport() {
    const transcriptText = document.getElementById('transcriptText').textContent;
    
    if (transcriptText && transcriptText !== 'Voice transcript will appear here...') {
        // Process the voice transcript to extract emergency information
        const emergencyData = parseVoiceTranscript(transcriptText);
        
        // Auto-fill the detailed form with extracted information
        fillDetailedForm(emergencyData);
        
        // Switch to detailed tab
        document.querySelector('[data-tab="detailed"]').click();
        
        showSuccessMessage('Voice report processed! Please review and submit the detailed form.');
    } else {
        showErrorMessage('No voice transcript to process. Please record your emergency report first.');
    }
}

function parseVoiceTranscript(transcript) {
    const emergencyData = {
        type: 'other',
        severity: 'medium',
        location: '',
        description: transcript
    };
    
    // Simple keyword detection for emergency type
    const lowerTranscript = transcript.toLowerCase();
    
    if (lowerTranscript.includes('fire') || lowerTranscript.includes('smoke') || lowerTranscript.includes('flame')) {
        emergencyData.type = 'fire';
    } else if (lowerTranscript.includes('flood') || lowerTranscript.includes('water') || lowerTranscript.includes('flooding')) {
        emergencyData.type = 'flood';
    } else if (lowerTranscript.includes('earthquake') || lowerTranscript.includes('shaking') || lowerTranscript.includes('tremor')) {
        emergencyData.type = 'earthquake';
    } else if (lowerTranscript.includes('medical') || lowerTranscript.includes('injury') || lowerTranscript.includes('hurt') || lowerTranscript.includes('sick')) {
        emergencyData.type = 'medical';
    } else if (lowerTranscript.includes('security') || lowerTranscript.includes('threat') || lowerTranscript.includes('intruder')) {
        emergencyData.type = 'security';
    }
    
    // Detect severity
    if (lowerTranscript.includes('critical') || lowerTranscript.includes('severe') || lowerTranscript.includes('urgent')) {
        emergencyData.severity = 'critical';
    } else if (lowerTranscript.includes('high') || lowerTranscript.includes('serious') || lowerTranscript.includes('major')) {
        emergencyData.severity = 'high';
    } else if (lowerTranscript.includes('low') || lowerTranscript.includes('minor')) {
        emergencyData.severity = 'low';
    }
    
    return emergencyData;
}

function fillDetailedForm(emergencyData) {
    const form = document.getElementById('detailedEmergencyForm');
    if (form) {
        form.querySelector('[name="emergency_type"]').value = emergencyData.type;
        form.querySelector('[name="severity"]').value = emergencyData.severity;
        form.querySelector('[name="description"]').value = emergencyData.description;
    }
}

// Location sharing functionality
function getCurrentLocation() {
    if ('geolocation' in navigator) {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Getting Location...';
        button.disabled = true;
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Use reverse geocoding to get address
                fetch(`https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=YOUR_API_KEY`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.results && data.results[0]) {
                            const address = data.results[0].formatted;
                            document.getElementById('quickLocation').value = address;
                        } else {
                            document.getElementById('quickLocation').value = `${lat}, ${lng}`;
                        }
                    })
                    .catch(() => {
                        document.getElementById('quickLocation').value = `${lat}, ${lng}`;
                    })
                    .finally(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            },
            (error) => {
                showErrorMessage('Unable to get your location. Please enter manually.');
                button.innerHTML = originalText;
                button.disabled = false;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000
            }
        );
    } else {
        showErrorMessage('Geolocation is not supported by this browser.');
    }
}

// Emergency services alert
function alertEmergencyServices() {
    if (confirm('This will immediately alert emergency services. Are you sure this is a real emergency?')) {
        const loadingToast = showLoadingMessage('Contacting emergency services...');
        
        // Simulate emergency services contact
        setTimeout(() => {
            loadingToast.remove();
            showSuccessMessage('Emergency services have been alerted! Help is on the way.');
            
            // You can implement actual emergency services API integration here
            // For example, automatically calling 911/108 or sending SMS alerts
        }, 2000);
    }
}

function submitEmergencyReport() {
    const activeTab = document.querySelector('.tab-content.active');
    let formData = new FormData();
    
    if (activeTab.id === 'quickTab') {
        // Quick report submission
        const selectedCategory = document.querySelector('.emergency-category.selected');
        const selectedSeverity = document.querySelector('.severity-btn.selected');
        const location = document.getElementById('quickLocation').value;
        const description = document.getElementById('quickDescription').value;
        
        if (!selectedCategory) {
            showErrorMessage('Please select an emergency category.');
            return;
        }
        
        if (!selectedSeverity) {
            showErrorMessage('Please select a severity level.');
            return;
        }
        
        if (!location.trim()) {
            showErrorMessage('Please provide a location.');
            return;
        }
        
        formData.append('emergency_type', selectedCategory.dataset.type);
        formData.append('severity', selectedSeverity.dataset.severity);
        formData.append('location', location);
        formData.append('description', description);
        formData.append('reporter_name', 'Emergency Administrator');
        formData.append('contact_number', 'Admin Dashboard');
        
    } else if (activeTab.id === 'detailedTab') {
        // Detailed report submission
        const form = document.getElementById('detailedEmergencyForm');
        const formDataObj = new FormData(form);
        
        // Validate required fields
        let isValid = true;
        const requiredFields = ['emergency_type', 'severity', 'location', 'description', 'reporter_name', 'contact_number'];
        
        requiredFields.forEach(field => {
            if (!formDataObj.get(field) || !formDataObj.get(field).trim()) {
                isValid = false;
            }
        });
        
        if (!isValid) {
            showErrorMessage('Please fill in all required fields.');
            return;
        }
        
        formData = formDataObj;
        
    } else if (activeTab.id === 'voiceTab') {
        // Voice report submission
        const transcript = document.getElementById('transcriptText').textContent;
        if (!transcript || transcript === 'Voice transcript will appear here...') {
            showErrorMessage('Please record a voice report first.');
            return;
        }
        
        const emergencyData = parseVoiceTranscript(transcript);
        formData.append('emergency_type', emergencyData.type);
        formData.append('severity', emergencyData.severity);
        formData.append('location', emergencyData.location || 'Voice Report - Location to be determined');
        formData.append('description', transcript);
        formData.append('reporter_name', 'Voice Report - Emergency Administrator');
        formData.append('contact_number', 'Admin Dashboard');
    }
    
    // Convert FormData to URLSearchParams for the existing endpoint
    const data = new URLSearchParams();
    for (let [key, value] of formData) {
        data.append(key, value);
    }
    
    const loadingToast = showLoadingMessage('Submitting emergency report...');
    
    fetch('/create_incident', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: data
    })
    .then(response => {
        loadingToast.remove();
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('emergencyModal')).hide();
            showSuccessMessage('Emergency report submitted successfully! Authorities have been notified.');
            setTimeout(() => location.reload(), 2000);
        } else {
            throw new Error('Failed to submit report');
        }
    })
    .catch(error => {
        loadingToast.remove();
        console.error('Error:', error);
        showErrorMessage('Failed to submit emergency report. Please try again or call emergency services directly.');
    });
}

// NDMA Report Function with PDF Preview
function openPDFReportModal() {
    const modal = new bootstrap.Modal(document.getElementById('pdfReportModal') || createPDFReportModal());
    generatePDFPreview();
    modal.show();
}

function createPDFReportModal() {
    const modalHtml = `
        <div class="modal fade" id="pdfReportModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-file-pdf me-2"></i>NDMA Report Preview
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div id="pdfPreview" class="pdf-preview-container">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Generating report...</span>
                                        </div>
                                        <p class="mt-2">Generating PDF report...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="edit-panel">
                                    <h6 class="mb-3"><i class="fas fa-edit me-2"></i>Edit Report Details</h6>
                                    <form id="reportEditForm">
                                        <div class="mb-3">
                                            <label class="form-label">Report Title</label>
                                            <input type="text" class="form-control" id="reportTitle" value="Emergency Management Report">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Priority Level</label>
                                            <select class="form-select" id="priorityLevel">
                                                <option value="normal">Normal</option>
                                                <option value="high" selected>High</option>
                                                <option value="critical">Critical</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Additional Notes</label>
                                            <textarea class="form-control" id="additionalNotes" rows="4" placeholder="Add any additional information for NDMA..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Include Sections</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="includeStats" checked>
                                                <label class="form-check-label" for="includeStats">Statistics Overview</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="includeIncidents" checked>
                                                <label class="form-check-label" for="includeIncidents">Recent Incidents</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="includeStudents" checked>
                                                <label class="form-check-label" for="includeStudents">Student Status</label>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="updatePDFPreview()">
                                            <i class="fas fa-sync me-2"></i>Update Preview
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-info" onclick="downloadPDF()">
                            <i class="fas fa-download me-2"></i>Download PDF
                        </button>
                        <button type="button" class="btn btn-primary" onclick="sendPDFToNDMA()">
                            <i class="fas fa-paper-plane me-2"></i>Send to NDMA
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    return document.getElementById('pdfReportModal');
}

function generatePDFPreview() {
    const previewContainer = document.getElementById('pdfPreview');
    
    // Simulate PDF generation with actual content
    setTimeout(() => {
        previewContainer.innerHTML = `
            <div class="pdf-document">
                <div class="pdf-header">
                    <h4 class="text-center text-primary">EMERGENCY MANAGEMENT REPORT</h4>
                    <p class="text-center text-muted">Generated on ${new Date().toLocaleDateString()}</p>
                    <hr>
                </div>
                <div class="pdf-content">
                    <div class="section mb-4">
                        <h6 class="text-primary"><i class="fas fa-chart-bar me-2"></i>Current Statistics</h6>
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="stat-box">
                                    <h5>${document.querySelector('.metric-primary h3').textContent}</h5>
                                    <small>Total Incidents</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-box">
                                    <h5>${document.querySelector('.metric-warning h3').textContent}</h5>
                                    <small>Active Alerts</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-box">
                                    <h5>${document.querySelector('.metric-success h3').textContent}</h5>
                                    <small>Safe Personnel</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-box">
                                    <h5>${document.querySelector('.metric-info h3').textContent}</h5>
                                    <small>Preparedness</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section mb-4">
                        <h6 class="text-primary"><i class="fas fa-users me-2"></i>Student Safety Status</h6>
                        <div class="row">
                            <div class="col-4 text-center">
                                <div class="safety-stat rescued">
                                    <h5>${document.querySelector('.stat-item.rescued h4').textContent}</h5>
                                    <small>Students Rescued</small>
                                </div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="safety-stat learning">
                                    <h5>${document.querySelector('.stat-item.learning h4').textContent}</h5>
                                    <small>Continuing Learning</small>
                                </div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="safety-stat safe">
                                    <h5>${document.querySelector('.stat-item.safe h4').textContent}</h5>
                                    <small>Confirmed Safe</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section mb-4">
                        <h6 class="text-primary"><i class="fas fa-exclamation-triangle me-2"></i>System Status</h6>
                        <p><strong>Overall Status:</strong> <span class="text-success">All Clear</span></p>
                        <p><strong>Emergency Services:</strong> Online</p>
                        <p><strong>Communication Network:</strong> Strong</p>
                        <p><strong>Weather Monitoring:</strong> Alert Active</p>
                    </div>
                    
                    <div class="section">
                        <h6 class="text-primary"><i class="fas fa-info-circle me-2"></i>Additional Information</h6>
                        <p>This report was generated automatically by the Emergency Management System.</p>
                        <p>For immediate assistance, please contact emergency services.</p>
                    </div>
                </div>
            </div>
        `;
    }, 1500);
}

function updatePDFPreview() {
    generatePDFPreview();
    showSuccessMessage('PDF preview updated successfully!');
}

function downloadPDF() {
    const loadingToast = showLoadingMessage('Generating PDF download...');
    
    // Simulate PDF generation and download
    setTimeout(() => {
        loadingToast.remove();
        showSuccessMessage('PDF downloaded successfully!');
        
        // Create a fake download link
        const link = document.createElement('a');
        link.href = 'data:application/pdf;base64,JVBERi0xLjQKJcfsj6IKNSAwIG9iago8PAovVHlwZSAvQ2F0YWxvZwovUGFnZXMgNCAwIFIKPj4KZW5kb2JqCjQgMCBvYmoKPDwKL1R5cGUgL1BhZ2VzCi9LaWRzIFszIDAgUl0KL0NvdW50IDEKPD4KZW5kb2JqCjMgMCBvYmoKPDwKL1R5cGUgL1BhZ2UKL1BhcmVudCA0IDAgUgovTWVkaWFCb3ggWzAgMCA2MTIgNzkyXQovUmVzb3VyY2VzIDw8Ci9Gb250IDw8Ci9GMSA2IDAgUgo+Pgo+PgovQ29udGVudHMgNSAwIFIKPj4KZW5kb2JqCjUgMCBvYmoKPDwKL0xlbmd0aCA0NAo+PgpzdHJlYW0KQlQKL0YxIDEyIFRmCjI4OCA3MjAgVGQKKEVtZXJnZW5jeSBNYW5hZ2VtZW50IFJlcG9ydCkgVGoKRVQKZW5kc3RyZWFtCmVuZG9iago=';
        link.download = `NDMA_Report_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }, 2000);
}

function sendPDFToNDMA() {
    if (confirm('Send this report to NDMA? This action will notify the National Disaster Management Authority with the current emergency status.')) {
        const loadingToast = showLoadingMessage('Sending report to NDMA...');
        
        const reportData = {
            title: document.getElementById('reportTitle').value,
            priority: document.getElementById('priorityLevel').value,
            notes: document.getElementById('additionalNotes').value,
            includeStats: document.getElementById('includeStats').checked,
            includeIncidents: document.getElementById('includeIncidents').checked,
            includeStudents: document.getElementById('includeStudents').checked,
            timestamp: new Date().toISOString()
        };
        
        fetch('/send_ndma_report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(reportData)
        })
        .then(response => response.json())
        .then(data => {
            loadingToast.remove();
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('pdfReportModal')).hide();
                showSuccessMessage(`Report sent to NDMA successfully! Reference ID: ${data.reference_id || 'N/A'}`);
                setTimeout(() => location.reload(), 2000);
            } else {
                throw new Error(data.message || 'Failed to send report');
            }
        })
        .catch(error => {
            loadingToast.remove();
            console.error('Error:', error);
            showErrorMessage('Failed to send NDMA report. Please try again or contact authorities directly.');
        });
    }
}

// Guardian Messages Function with Safety Check
function openGuardianMessageModal() {
    const modal = new bootstrap.Modal(document.getElementById('guardianMessageModal') || createGuardianMessageModal());
    loadStudentSafetyStatus();
    modal.show();
}

function createGuardianMessageModal() {
    const modalHtml = `
        <div class="modal fade" id="guardianMessageModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-comment-medical me-2"></i>Send Messages to Guardians
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="safetyStatusCheck" class="mb-4">
                            <div class="text-center">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Checking student safety status...</span>
                                </div>
                                <p class="mt-2">Checking student safety status...</p>
                            </div>
                        </div>
                        
                        <div id="safetyResults" style="display: none;">
                            <div class="safety-overview mb-4">
                                <h6><i class="fas fa-users me-2"></i>Safety Status Overview</h6>
                                <div class="row text-center">
                                    <div class="col-md-6">
                                        <div class="status-card safe-card">
                                            <h4 id="safeStudentCount">0</h4>
                                            <p>Students Safe</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="status-card alert-card">
                                            <h4 id="unsafeStudentCount">0</h4>
                                            <p>Students Need Help</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="unsafeStudentsList" style="display: none;">
                                <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Students Requiring Attention</h6>
                                <div id="unsafeStudentsContainer" class="mb-3">
                                    <!-- Unsafe students will be listed here -->
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Custom Message for Unsafe Students' Guardians</label>
                                    <textarea class="form-control" id="unsafeMessage" rows="3" placeholder="Enter custom message for guardians of students who need help...">Your child requires immediate attention. Please contact the school emergency line for more information.</textarea>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Message for Safe Students' Guardians</label>
                                <textarea class="form-control" id="safeMessage" rows="3" placeholder="Enter message for guardians of safe students...">Your child is safe and secure. All emergency protocols are being followed. No immediate action required.</textarea>
                            </div>
                            
                            <div class="message-options">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeLocation" checked>
                                    <label class="form-check-label" for="includeLocation">Include school location in messages</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeEmergencyContact" checked>
                                    <label class="form-check-label" for="includeEmergencyContact">Include emergency contact numbers</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="sendGuardianMessages()">
                            <i class="fas fa-paper-plane me-2"></i>Send Messages
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    return document.getElementById('guardianMessageModal');
}

function loadStudentSafetyStatus() {
    const statusCheck = document.getElementById('safetyStatusCheck');
    const results = document.getElementById('safetyResults');
    
    // Simulate API call to check student safety status
    setTimeout(() => {
        statusCheck.style.display = 'none';
        results.style.display = 'block';
        
        // Simulate student safety data
        const safeStudents = parseInt(document.querySelector('.stat-item.safe h4').textContent) || 245;
        const unsafeStudents = Math.floor(Math.random() * 5); // Random number of unsafe students
        
        document.getElementById('safeStudentCount').textContent = safeStudents;
        document.getElementById('unsafeStudentCount').textContent = unsafeStudents;
        
        if (unsafeStudents > 0) {
            document.getElementById('unsafeStudentsList').style.display = 'block';
            const container = document.getElementById('unsafeStudentsContainer');
            
            let unsafeStudentsHtml = '';
            for (let i = 1; i <= unsafeStudents; i++) {
                unsafeStudentsHtml += `
                    <div class="student-alert-item">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            <div>
                                <strong>Student ${String(Math.floor(Math.random() * 900) + 100).padStart(3, '0')}</strong>
                                <small class="text-muted d-block">Last check-in: ${Math.floor(Math.random() * 60)} minutes ago</small>
                            </div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = unsafeStudentsHtml;
        }
    }, 2000);
}

function sendGuardianMessages() {
    const safeCount = parseInt(document.getElementById('safeStudentCount').textContent);
    const unsafeCount = parseInt(document.getElementById('unsafeStudentCount').textContent);
    const safeMessage = document.getElementById('safeMessage').value;
    const unsafeMessage = document.getElementById('unsafeMessage').value;
    const includeLocation = document.getElementById('includeLocation').checked;
    
    const messageData = {
        safeStudentCount: safeCount,
        unsafeStudentCount: unsafeCount,
        safeMessage: safeMessage,
        unsafeMessage: unsafeMessage,
        includeLocation: includeLocation,
        timestamp: new Date().toISOString()
    };
    
    // Show immediate confirmation that message is being sent
    showSuccessMessage('Message sent to guardians successfully!');
    
    // Close the modal immediately
    bootstrap.Modal.getInstance(document.getElementById('guardianMessageModal')).hide();
    
    // Send the actual message in the background
    fetch('/send_guardian_messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(messageData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`Messages sent successfully! ${data.safeMessagesSent || 0} safe messages and ${data.unsafeMessagesSent || 0} alert messages delivered.`);
        } else {
            console.error('Error sending messages:', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Legacy NDMA Report Function (for backward compatibility)
function sendNDMAReport() {
    if (confirm('Send emergency report to NDMA? This will include all current incident data and statistics.')) {
        const loadingToast = showLoadingMessage('Preparing NDMA report...');
        
        fetch('/send_ndma_report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                timestamp: new Date().toISOString(),
                emergency_level: 'high',
                include_stats: true
            })
        })
        .then(response => response.json())
        .then(data => {
            loadingToast.remove();
            if (data.success) {
                showSuccessMessage('NDMA report sent successfully! Reference ID: ' + (data.reference_id || 'N/A'));
            } else {
                throw new Error(data.message || 'Failed to send report');
            }
        })
        .catch(error => {
            loadingToast.remove();
            console.error('Error:', error);
            showErrorMessage('Failed to send NDMA report. Please try again or contact authorities directly.');
        });
    }
}

// Guardian Messages Function
function sendSafeMessages() {
    // Show immediate confirmation that message is being sent
    showSuccessMessage('Safety messages sent to guardians successfully!');
    
    // Send the actual message in the background
    fetch('/send_guardian_messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message_type: 'safety_update',
            include_location: true,
            emergency_contact: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`Safety messages sent to ${data.sent_count || 0} guardians successfully!`);
        } else {
            console.error('Error sending messages:', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
// Quick Check-in Function  
function quickCheckin() {
    const modal = new bootstrap.Modal(document.getElementById('checkinModal') || createCheckinModal());
    modal.show();
}

function createCheckinModal() {
    const modalHtml = `
        <div class="modal fade" id="checkinModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user-check me-2"></i>Quick Safety Check-in
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <p class="text-muted">Please confirm your current safety status</p>
                        </div>
                        <div class="d-grid gap-3">
                            <button type="button" class="btn btn-success btn-lg" onclick="submitCheckin('safe')">
                                <i class="fas fa-check-circle me-2"></i>I'm Safe
                            </button>
                            <button type="button" class="btn btn-warning btn-lg" onclick="submitCheckin('need_help')">
                                <i class="fas fa-hand-paper me-2"></i>Need Assistance
                            </button>
                            <button type="button" class="btn btn-danger btn-lg" onclick="submitCheckin('emergency')">
                                <i class="fas fa-exclamation-triangle me-2"></i>Emergency Help
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    return document.getElementById('checkinModal');
}

function submitCheckin(status) {
    fetch('/checkin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `status=${status}&location=Dashboard`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('checkinModal')).hide();
            showSuccessMessage('Check-in recorded successfully!');
            setTimeout(() => location.reload(), 1500);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorMessage('Failed to record check-in. Please try again.');
    });
}

function callContact(number) {
    if (confirm(`Call ${number}?`)) {
        window.open(`tel:${number}`, '_self');
    }
}

function refreshDashboard() {
    location.reload();
}

function showSuccessMessage(message) {
    const toast = document.createElement('div');
    toast.className = 'position-fixed top-0 end-0 p-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="toast show align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

function showErrorMessage(message) {
    const toast = document.createElement('div');
    toast.className = 'position-fixed top-0 end-0 p-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="toast show align-items-center text-white bg-danger border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-exclamation-triangle me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

function showLoadingMessage(message) {
    const toast = document.createElement('div');
    toast.className = 'position-fixed top-0 end-0 p-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="toast show align-items-center text-white bg-info border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>${message}
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(toast);
    return toast;
}

// Auto-refresh dashboard every 2 minutes
setInterval(function() {
    fetch('/api/dashboard_stats')
        .then(response => response.json())
        .then(data => {
            console.log('Dashboard stats updated:', data);
        })
        .catch(error => console.error('Error updating stats:', error));
}, 120000);

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}