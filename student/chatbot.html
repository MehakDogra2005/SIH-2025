<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disaster Management Support Chatbot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #1a73e8;
            --primary-light: #4285f4;
            --primary-dark: #0d47a1;
            --secondary: #34a853;
            --accent: #f25c54;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-sidebar: #f5f6fa;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border: #e8eaed;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
            --radius: 8px;
            --transition: all 0.2s ease;
            --p6: #c8e5f3;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        /* Hamburger Menu */
        .hamburger-menu {
            position: fixed;
            top: 20px;
            left: 5px;
            z-index: 1001;
            width: 20px;
            height: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 3px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }
        
        .hamburger-menu:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
            box-shadow: var(--shadow-hover);
            transform: scale(1.05);
        }
        
        .hamburger-menu:active {
            transform: scale(0.98);
        }
        
        .hamburger-line {
            width: 18px;
            height: 2px;
            background: var(--text-primary);
            border-radius: 1px;
            transition: var(--transition);
        }
        
        .hamburger-menu.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(4px, 4px);
            background: var(--primary);
        }
        
        .hamburger-menu.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger-menu.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -5px);
            background: var(--primary);
        }
        
        .hamburger-menu.active {
            border-color: var(--primary);
            background: var(--bg-secondary);
        }

        /* Dashboard Navigation Sidebar */
        .dashboard-sidebar {
            position: fixed;
            left: -280px;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, var(--primary), var(--primary-dark));
            color: #fff;
            padding: 22px;
            overflow-y: auto;
            box-shadow: var(--shadow);
            z-index: 1000;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            transition: left 0.3s ease;
        }
        
        .dashboard-sidebar.open {
            left: 0;
        }
        
        .dashboard-sidebar .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .dashboard-sidebar .logo i {
            font-size: 22px;
            color: var(--p6, #c8e5f3);
        }
        
        .dashboard-sidebar .logo h1 {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }
        
        .dashboard-sidebar .menu-items {
            margin-top: 18px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .dashboard-sidebar .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            color: rgba(255, 255, 255, 0.95);
            text-decoration: none;
        }
        
        .dashboard-sidebar .menu-item i {
            width: 20px;
            text-align: center;
        }
        
        .dashboard-sidebar .menu-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }
        
        .dashboard-sidebar .menu-item.active {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.06));
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        }

        /* Overlay for dashboard sidebar */
        .dashboard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .dashboard-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* Sidebar - Conversation History */
        .sidebar {
            width: 300px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
        }
        
        .app-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            margin-left: 15px;
        }
        
        .app-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        
        .sidebar-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .sidebar-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: var(--radius);
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .sidebar-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }
        
        .search-container {
            position: relative;
            margin-bottom: 12px;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            outline: none;
            transition: var(--transition);
        }
        
        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .user-profile {
            padding: 12px;
            background: var(--bg-primary);
            border-radius: var(--radius);
            margin: 16px;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border);
            border-top: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .user-profile:hover {
            background: var(--bg-secondary);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .user-status {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .history-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border);
            position: relative;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            box-shadow: var(--shadow);
        }
        
        .history-item:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
            box-shadow: var(--shadow-hover);
        }
        
        .history-item:hover .delete-chat-btn {
            opacity: 1;
            visibility: visible;
        }
        
        .history-item:hover .edit-chat-btn {
            opacity: 1;
            visibility: visible;
        }
        
        .history-item.active {
            background: var(--bg-primary);
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }
        
        .history-content {
            flex: 1;
            pointer-events: none;
            padding-right: 60px; /* Make space for both buttons */
        }
        
        .delete-chat-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            border: none;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            pointer-events: auto;
            z-index: 10;
        }
        
        .delete-chat-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }
        
        .edit-chat-btn {
            position: absolute;
            top: 12px;
            right: 42px;
            width: 24px;
            height: 24px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            pointer-events: auto;
            z-index: 10;
        }
        
        .edit-chat-btn:hover {
            background: var(--primary-light);
            transform: scale(1.1);
        }
        
        .history-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        
        .history-preview {
            font-size: 12px;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .history-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* Main Chat Area */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 20px 24px 20px 70px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
        }
        
        .chat-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .chat-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-secondary);
            height: 70vh;
            max-height: 600px;
            min-height: 400px;
        }
        
        .message {
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }
        
        .user-message {
            flex-direction: row-reverse;
            justify-content: flex-start;
        }
        
        .ai-message {
            flex-direction: row;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .user-avatar {
            background: var(--primary);
            color: white;
        }
        
        .ai-avatar {
            background: var(--secondary);
            color: white;
        }
        
        .message-content {
            flex: 0 0 auto;
            max-width: 55%;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .user-message .message-content {
            align-items: flex-end;
            margin-left: auto;
        }
        
        .ai-message .message-content {
            align-items: flex-start;
            margin-right: auto;
        }
        
        .message-text {
            background: var(--bg-primary);
            padding: 8px 12px;
            border-radius: 18px;
            border: 1px solid var(--border);
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            position: relative;
            font-size: 14px;
            width: fit-content;
            max-width: 100%;
            display: inline-block;
        }
        
        /* Copy button styles */
        .copy-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-secondary);
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            z-index: 10;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .ai-message .message-text:hover .copy-btn {
            opacity: 1;
            visibility: visible;
        }
        
        .copy-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.1);
        }
        
        .copy-btn.copied {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .copy-btn.copied:hover {
            background: var(--secondary);
            color: white;
        }
        
        /* Enhanced styling for AI messages with markdown content */
        .ai-message .message-text {
            background: var(--bg-secondary);
            border-color: var(--border);
        }
        
        .ai-message .message-text h1,
        .ai-message .message-text h2,
        .ai-message .message-text h3 {
            margin: 8px 0;
            color: var(--primary);
            font-weight: 600;
        }
        
        .ai-message .message-text h1 { font-size: 18px; }
        .ai-message .message-text h2 { font-size: 16px; }
        .ai-message .message-text h3 { font-size: 14px; }
        
        .ai-message .message-text strong {
            color: var(--primary);
            font-weight: 600;
        }
        
        .ai-message .message-text em {
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .ai-message .message-text ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .ai-message .message-text li {
            margin: 4px 0;
            list-style-type: disc;
        }
        
        .ai-message .message-text p {
            margin: 8px 0;
        }
        
        .ai-message .message-text code {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border: 1px solid var(--border);
        }
        
        .ai-message .message-text blockquote {
            border-left: 3px solid var(--primary);
            margin: 8px 0;
            padding-left: 12px;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .user-message .message-text {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .ai-message .message-text {
            background: var(--bg-secondary);
            border-color: var(--border);
            position: relative;
            padding-bottom: 25px; /* Space for copy button */
        }
        
        .ai-message .message-time {
            text-align: right;
        }
        
        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            flex-direction: row-reverse;
            justify-content: flex-start;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-primary);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0ms; }
        .typing-dot:nth-child(2) { animation-delay: 200ms; }
        .typing-dot:nth-child(3) { animation-delay: 400ms; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }
        
        /* Input Area */
        .input-area {
            padding: 20px 24px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
        }
        
        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .input-wrapper {
            flex: 1;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 22px;
            padding: 4px;
            transition: var(--transition);
        }
        
        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }
        
        .mic-btn-left {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background: transparent;
            color: var(--text-secondary);
            transition: var(--transition);
            margin-left: 4px;
        }
        
        .mic-btn-left:hover {
            background: var(--bg-secondary);
            color: var(--primary);
        }
        
        .mic-btn-left.recording {
            background: var(--accent);
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        .message-input {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: 12px 16px;
            border: none;
            outline: none;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            background: transparent;
        }
        
        .input-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: var(--transition);
        }
        
        .attach-btn {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .attach-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .mic-btn {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .mic-btn:hover {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .mic-btn.recording {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .send-btn {
            background: var(--primary);
            color: white;
        }
        
        .send-btn:hover {
            background: var(--primary-light);
        }
        
        .send-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }
        
        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }
        
        .empty-icon {
            width: 80px;
            height: 80px;
            background: var(--bg-sidebar);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        
        .empty-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .empty-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        
        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            max-width: 400px;
        }
        
        .chip {
            padding: 8px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .chip:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* File upload styles */
        .file-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-top: 8px;
            max-width: 300px;
        }
        
        .user-message .file-message {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .file-info {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-message .file-name {
            color: white;
        }
        
        .file-size {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .user-message .file-size {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .file-preview {
            width: 200px;
            max-height: 200px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 8px;
        }
        
        .upload-progress {
            position: relative;
            overflow: hidden;
        }
        
        .upload-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: uploadShimmer 1.5s infinite;
        }
        
        @keyframes uploadShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 16px;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .processing-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .messages-container {
                padding: 12px;
                height: 65vh;
                max-height: 500px;
                min-height: 300px;
            }
            
            .input-area {
                padding: 16px;
            }
            
            .chat-header {
                padding: 16px 16px 16px 65px;
            }
            
            .hamburger-menu {
                top: 12px;
                left: 12px;
                width: 34px;
                height: 34px;
            }
            
            .hamburger-line {
                width: 16px;
            }
            
            .message-content {
                max-width: 70%;
            }
            
            .message-text {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .message {
                margin-bottom: 12px;
                gap: 8px;
            }
        }
        
        @media (max-width: 640px) {
            .main-area {
                width: 100%;
            }
            
            .chat-header {
                padding: 14px 14px 14px 58px;
            }
            
            .hamburger-menu {
                top: 10px;
                left: 10px;
                width: 32px;
                height: 32px;
            }
            
            .hamburger-line {
                width: 14px;
            }
            
            .message-content {
                max-width: 75%;
            }
            
            .message-text {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Dashboard Sidebar Overlay -->
        <div class="dashboard-overlay" id="dashboardOverlay" onclick="closeDashboardSidebar()"></div>
        
        <!-- Hamburger Menu -->
        <div class="hamburger-menu" id="hamburgerMenu" onclick="toggleDashboardSidebar()">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
        </div>
        
        <!-- Dashboard Navigation Sidebar -->
        <aside class="dashboard-sidebar" id="dashboardSidebar">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <h1>ResQ</h1>
            </div>
            <div class="menu-items">
                <div class="menu-item" onclick="navigateTo('dashboard-student.html')">
                    <i class="fas fa-home"></i><span>Dashboard</span>
                </div>
                <div class="menu-item" onclick="navigateTo('education-modules.html')">
                    <i class="fas fa-book"></i><span>Education Modules</span>
                </div>
                <div class="menu-item" onclick="navigateTo('sandbox-simulator.html')">
                    <i class="fas fa-gamepad"></i><span>Sandbox Simulator</span>
                </div>
                <div class="menu-item" onclick="navigateTo('consultation.html')">
                    <i class="fas fa-phone-alt"></i><span>Emergency Contacts</span>
                </div>
                <div class="menu-item" onclick="navigateTo('../advanced-map.html')">
                    <i class="fas fa-map-marked-alt"></i><span>Disaster Map</span>
                </div>
                <div class="menu-item active">
                    <i class="fas fa-robot"></i><span>AI Helper</span>
                </div>
                <div class="menu-item" onclick="navigateTo('gamified-learning.html')">
                    <i class="fas fa-graduation-cap"></i><span>Gamified Learning</span>
                </div>
                <div class="menu-item" onclick="navigateTo('profile-badges.html')">
                    <i class="fas fa-user"></i><span>Profile & Badges</span>
                </div>
                <div class="menu-item" onclick="navigateTo('settings.html')">
                    <i class="fas fa-cog"></i><span>Settings</span>
                </div>
            </div>
        </aside>
        
        <!-- Sidebar - Chat History -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-title">DisasterAI Assistant</div>
                <div class="app-subtitle">AI-powered disaster guidance and support</div>
                
                <div class="sidebar-actions">
                    <button class="sidebar-btn" onclick="startNewChat()">
                        <i class="fas fa-plus"></i>
                        New Chat
                    </button>
                    <button class="sidebar-btn" onclick="toggleSearch()">
                        <i class="fas fa-search"></i>
                        Search
                    </button>
                </div>
                
                <div class="search-container" id="searchContainer" style="display: none;">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search chats..." onkeyup="searchChats()" />
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            
            <div class="chat-history" id="chatHistory">
                <!-- Chat history will be populated here -->
            </div>
            
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <div class="user-name" id="userName">User</div>
                    <div class="user-status">Online</div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="main-area">
            <div class="chat-header">
                <div class="chat-title" id="chatTitle">New Chat</div>
                <div class="chat-subtitle">AI-powered emergency guidance and support</div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="empty-title">How can I help you today?</div>
                    <div class="empty-subtitle">Ask me about disaster preparedness, emergency situations, or if you need psychological support. Upload images, videos, or PDFs for specialized analysis with enhanced AI prompts.</div>
                    
                    <div class="suggestion-chips">
                        <div class="chip" onclick="sendSuggestion('I am feeling anxious about disaster')">üò∞ Feeling Anxious</div>
                        <div class="chip" onclick="sendSuggestion('Emergency preparedness tips')">üéí Preparedness</div>
                        <div class="chip" onclick="sendSuggestion('First aid guidance')">üè• First Aid</div>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <button class="mic-btn-left" id="micBtn" title="Voice input">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="Type your message here..."
                            rows="1"
                        ></textarea>
                    </div>
                    <div class="input-actions">
                        <label for="fileInput" class="action-btn attach-btn" title="Attach file">
                            <i class="fas fa-paperclip"></i>
                        </label>
                        <input type="file" id="fileInput" accept="image/*,video/*,.pdf" style="display: none;">
                        <button class="action-btn send-btn" id="sendBtn" title="Send message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentChatId = null;
        let isRecording = false;
        let recognition = null;
        let currentMessage = '';
        
        // Initialize chat history from localStorage (shared with popup chatbot)
        let chatHistory = JSON.parse(localStorage.getItem('disasterAI_chatHistory') || '[]');
        
        // Initialize speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('micBtn').classList.add('recording');
                document.getElementById('micBtn').innerHTML = '<i class="fas fa-stop"></i>';
            };
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                const messageInput = document.getElementById('messageInput');
                messageInput.value = currentMessage + finalTranscript + interimTranscript;
                
                if (finalTranscript) {
                    currentMessage += finalTranscript;
                    // Auto-send voice input when speech recognition completes
                    setTimeout(() => {
                        if (finalTranscript.trim()) {
                            handleVoiceInput(finalTranscript);
                        }
                    }, 500); // Small delay to ensure recognition has fully completed
                }
            };
            
            recognition.onend = () => {
                isRecording = false;
                document.getElementById('micBtn').classList.remove('recording');
                document.getElementById('micBtn').innerHTML = '<i class="fas fa-microphone"></i>';
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                document.getElementById('micBtn').classList.remove('recording');
                document.getElementById('micBtn').innerHTML = '<i class="fas fa-microphone"></i>';
            };
        }
        
        // DOM elements
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const micBtn = document.getElementById('micBtn');
        const fileInput = document.getElementById('fileInput');
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');
        const chatTitle = document.getElementById('chatTitle');
        
        // Configuration for API handling
        let geminiApiKey = ''; // Will be set later
        const BACKEND_URL = 'http://localhost:5000'; // Backend server URL
        let backendAvailable = false;
        
        // Enhanced backend status checking with retry logic
        async function checkBackendStatus() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/status`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    signal: AbortSignal.timeout(5000) // 5 second timeout for status check
                });
                
                if (!response.ok) {
                    throw new Error(`Status check failed: ${response.status}`);
                }
                
                const data = await response.json();
                backendAvailable = data.backend_available;
                
                console.log('Backend status:', {
                    available: data.backend_available,
                    geminiAvailable: data.gemini_available,
                    supportedFiles: data.supported_files,
                    maxFileSize: data.max_file_size_mb,
                    timestamp: data.timestamp
                });
                
                // Update UI to reflect backend status
                updateBackendStatusUI(data);
                
                return data;
            } catch (error) {
                console.error('Backend status check failed:', error);
                backendAvailable = false;
                updateBackendStatusUI(null);
                return null;
            }
        }
        
        // Update UI to show backend status
        function updateBackendStatusUI(statusData) {
            // You could add a status indicator to the UI here
            const chatSubtitle = document.querySelector('.chat-subtitle');
            if (chatSubtitle) {
                if (statusData && statusData.backend_available) {
                    chatSubtitle.innerHTML = 'AI-powered emergency guidance and support | üü¢ Backend Connected';
                    if (!statusData.gemini_available) {
                        chatSubtitle.innerHTML += ' | ‚ö†Ô∏è Gemini API not configured';
                    }
                } else {
                    chatSubtitle.innerHTML = 'AI-powered emergency guidance and support | üî¥ Backend Offline (Local Mode)';
                }
            }
        }
        
        // Periodic backend health check
        function startBackendMonitoring() {
            // Check backend status every 2 minutes
            setInterval(async () => {
                const wasAvailable = backendAvailable;
                await checkBackendStatus();
                
                // Notify user if backend status changed
                if (wasAvailable !== backendAvailable) {
                    const statusMessage = backendAvailable 
                        ? 'üü¢ Backend connection restored! Enhanced AI features are now available.'
                        : 'üî¥ Backend connection lost. Switching to local mode.';
                    
                    // Add a subtle notification (you could make this more prominent)
                    console.log('Backend status change:', statusMessage);
                }
            }, 120000); // 2 minutes
        }
        
        // Enhanced error reporting
        function reportError(errorType, errorMessage, context = {}) {
            const errorReport = {
                type: errorType,
                message: errorMessage,
                context: context,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            console.error('Error Report:', errorReport);
            
            // You could send this to an analytics service or error tracking system
            // Example: sendToAnalytics('error', errorReport);
        }
        
        const isGeminiAvailable = () => geminiApiKey && geminiApiKey.trim() !== '';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check backend availability and start monitoring
            checkBackendStatus().then(() => {
                startBackendMonitoring();
            });
            
            // Initialize user profile
            initializeUserProfile();
            
            // Event listeners
            messageInput.addEventListener('input', handleInputChange);
            messageInput.addEventListener('keypress', handleKeyPress);
            sendBtn.addEventListener('click', sendMessage);
            micBtn.addEventListener('click', toggleRecording);
            fileInput.addEventListener('change', handleFileUpload);
            
            // Initialize the app
            renderChatHistory();
            
            // Check if opened from consultation page with enhanced welcome
            if (document.referrer.includes('consultation.html') || window.opener) {
                setTimeout(async () => {
                    const backendStatus = await checkBackendStatus();
                    let welcomeMessage = "üöÄ **Welcome to Enhanced DisasterAI!** You've accessed our improved chat interface with:\n\n‚ú® Better design and animations\nüÜò Advanced emergency protocols\nüìÅ Enhanced file upload support\n‚å®Ô∏è Voice input capabilities\nüß† Smarter AI responses with context awareness\n\n";
                    
                    if (backendStatus && backendStatus.backend_available) {
                        welcomeMessage += "üîß **Backend Status**: Connected ‚úÖ\n";
                        welcomeMessage += `üìä **Gemini API**: ${backendStatus.gemini_available ? 'Ready ‚úÖ' : 'Not configured ‚ö†Ô∏è'}\n`;
                        welcomeMessage += `üìÅ **File Support**: ${backendStatus.supported_files.join(', ')}\n`;
                        welcomeMessage += `üìè **Max File Size**: ${backendStatus.max_file_size_mb}MB\n\n`;
                        
                        if (!backendStatus.gemini_available) {
                            welcomeMessage += "üí° **Tip**: Set your Gemini API key using `setGeminiApiKey('your-key')` in console for enhanced AI features.\n\n";
                        }
                        
                        welcomeMessage += "üéØ **Enhanced Features**:\n";
                        welcomeMessage += "‚Ä¢ Context-aware responses\n";
                        welcomeMessage += "‚Ä¢ Specialized disaster management prompts\n";
                        welcomeMessage += "‚Ä¢ Multi-modal file analysis\n";
                        welcomeMessage += "‚Ä¢ Psychological support protocols\n\n";
                    } else {
                        welcomeMessage += "‚ö†Ô∏è **Backend Status**: Offline (using local responses)\n\n";
                        welcomeMessage += "üí° **Tip**: Start the Python backend server for enhanced AI features with specialized prompts.\n\n";
                        welcomeMessage += "üîß **To start backend**: Run `python chatbot_backend.py` in the student directory.\n\n";
                    }
                    
                    welcomeMessage += "How can I assist you today? Feel free to ask about disaster preparedness, share images for analysis, or if you need psychological support during stressful times.";
                    
                    addMessage(welcomeMessage, 'ai');
                    emptyState.style.display = 'none';
                }, 500);
            }
        });
        
        // Auto-resize textarea
        function handleInputChange() {
            const textarea = messageInput;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            
            // Enable/disable send button
            sendBtn.disabled = !textarea.value.trim();
        }
        
        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        // Enhanced voice input processing
        function toggleRecording() {
            if (!recognition) {
                alert('Speech recognition is not supported in your browser.');
                return;
            }
            
            if (isRecording) {
                recognition.stop();
            } else {
                currentMessage = messageInput.value;
                recognition.start();
            }
        }
        
        // Enhanced voice input result handling
        function handleVoiceInput(finalTranscript) {
            if (!finalTranscript.trim()) return;
            
            const voiceInputContext = {
                message: finalTranscript.trim(),
                timestamp: new Date().toISOString(),
                inputMethod: 'voice',
                sessionId: currentChatId,
                previousContext: getCurrentChatContext(),
                confidence: 'voice-input' // Could be enhanced with actual confidence scores
            };
            
            // Hide empty state
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Create new chat if needed
            if (!currentChatId) {
                startNewChat();
            }
            
            // Add user message
            addMessage(finalTranscript.trim(), 'user');
            
            // Clear input
            messageInput.value = '';
            currentMessage = '';
            handleInputChange();
            
            // Show typing indicator
            showTypingIndicator();
            
            // Process voice input with context
            if (backendAvailable) {
                processMessageWithBackend(voiceInputContext);
            } else {
                setTimeout(() => {
                    hideTypingIndicator();
                    const response = generateAIResponse(finalTranscript.trim(), voiceInputContext);
                    addMessage(response, 'ai');
                    updateChatHistory(finalTranscript.trim(), response);
                }, 1500 + Math.random() * 1000);
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('‚ö†Ô∏è File too large\n\nPlease select a file smaller than 10MB.');
                event.target.value = '';
                return;
            }
            
            // Validate file type
            const allowedTypes = ['image/', 'video/', 'application/pdf'];
            const isValidType = allowedTypes.some(type => file.type.startsWith(type));
            
            if (!isValidType) {
                alert('‚ö†Ô∏è Unsupported file type\n\nPlease select an image, video, or PDF file.');
                event.target.value = '';
                return;
            }
            
            // Hide empty state
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Create new chat if needed
            if (!currentChatId) {
                startNewChat();
            }
            
            // Add file message
            addFileMessage(file);
            
            // Clear file input
            event.target.value = '';
            
            // Process file
            processFile(file);
        }
        
        function addFileMessage(file) {
            const messagesDiv = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.id = `file-message-${Date.now()}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Determine file icon and color
            let iconClass = 'fas fa-file';
            let iconColor = '#6c757d';
            
            if (file.type.startsWith('image/')) {
                iconClass = 'fas fa-image';
                iconColor = '#17a2b8';
            } else if (file.type.startsWith('video/')) {
                iconClass = 'fas fa-video';
                iconColor = '#e83e8c';
            } else if (file.type === 'application/pdf') {
                iconClass = 'fas fa-file-pdf';
                iconColor = '#dc3545';
            }
            
            const fileSize = formatFileSize(file.size);
            
            let fileContent = `
                <div class="file-message upload-progress">
                    <div class="file-icon" style="background: ${iconColor}">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${fileSize}</div>
                    </div>
                </div>
            `;
            
            // Add image preview for images
            if (file.type.startsWith('image/')) {
                const imageUrl = URL.createObjectURL(file);
                fileContent += `<img src="${imageUrl}" class="file-preview" alt="Preview">`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="message-content">
                    ${fileContent}
                    <div class="message-time">${timeString}</div>
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return messageDiv;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Enhanced file processing with context
        function processFile(file) {
            const fileContext = {
                message: `[File Upload: ${file.name}] Please analyze this file and provide disaster management guidance.`,
                timestamp: new Date().toISOString(),
                inputMethod: 'file',
                sessionId: currentChatId,
                previousContext: getCurrentChatContext(),
                fileInfo: {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    lastModified: file.lastModified
                }
            };
            
            if (backendAvailable) {
                // Process with backend API (which will use specialized prompts + Gemini)
                processFileWithBackend(file, fileContext);
            } else if (isGeminiAvailable()) {
                // Fallback to direct Gemini API
                processWithGemini(file);
            } else {
                // Fallback to local processing
                processLocally(file);
            }
        }
        
        // Enhanced file processing with backend
        async function processFileWithBackend(file, fileContext) {
            showTypingIndicator();
            
            try {
                const formData = new FormData();
                formData.append('message', fileContext.message);
                formData.append('files', file);
                
                // Add context as JSON string
                formData.append('context', JSON.stringify({
                    inputMethod: fileContext.inputMethod,
                    sessionId: fileContext.sessionId,
                    timestamp: fileContext.timestamp,
                    previousContext: fileContext.previousContext,
                    fileInfo: fileContext.fileInfo
                }));
                
                console.log('Sending file to backend:', {
                    fileName: file.name,
                    fileSize: file.size,
                    fileType: file.type,
                    context: fileContext
                });
                
                const response = await fetch(`${BACKEND_URL}/api/chat`, {
                    method: 'POST',
                    body: formData,
                    signal: AbortSignal.timeout(45000) // 45 second timeout for file uploads
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    hideTypingIndicator();
                    addMessage(data.response, 'ai');
                    updateChatHistory(`[File: ${file.name}]`, data.response);
                    
                    console.log('File processing successful:', {
                        messageType: data.message_type,
                        timestamp: data.timestamp
                    });
                } else {
                    throw new Error(data.error || 'Backend file processing failed');
                }
                
            } catch (error) {
                console.error('Backend file processing error:', error);
                hideTypingIndicator();
                
                // Enhanced error handling for file uploads
                let errorMessage;
                if (error.name === 'AbortError' || error.message.includes('timeout')) {
                    errorMessage = '‚è∞ File upload is taking longer than expected. ';
                } else if (error.message.includes('413') || error.message.includes('too large')) {
                    errorMessage = 'üìÅ File is too large for processing. ';
                } else if (error.message.includes('415') || error.message.includes('unsupported')) {
                    errorMessage = 'üìÑ File type is not supported. ';
                } else {
                    errorMessage = '‚ö†Ô∏è Error processing file with backend. ';
                }
                
                // Fallback to direct Gemini API if backend fails
                if (isGeminiAvailable()) {
                    addMessage(errorMessage + 'Falling back to direct Gemini API...', 'ai');
                    setTimeout(() => processWithGemini(file), 1000);
                } else {
                    addMessage(errorMessage + 'Please ensure the backend server is running or provide a Gemini API key.', 'ai');
                }
            }
        }
        
        async function processWithGemini(file) {
            showTypingIndicator();
            
            try {
                // Convert file to base64
                const base64Data = await fileToBase64(file);
                
                // Prepare the request
                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: getGeminiPrompt(file.type)
                            },
                            {
                                inline_data: {
                                    mime_type: file.type,
                                    data: base64Data.split(',')[1] // Remove data:type;base64, prefix
                                }
                            }
                        ]
                    }]
                };
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.candidates[0]?.content?.parts[0]?.text || 'Sorry, I could not analyze this file.';
                
                hideTypingIndicator();
                addMessage(aiResponse, 'ai');
                updateChatHistory(`[File: ${file.name}]`, aiResponse);
                
            } catch (error) {
                console.error('Gemini API error:', error);
                hideTypingIndicator();
                addMessage('‚ö†Ô∏è Sorry, I encountered an error processing your file. Please try again or contact support if the issue persists.', 'ai');
            }
        }
        
        function processLocally(file) {
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                
                let response = '';
                if (file.type.startsWith('image/')) {
                    response = `üì∏ **Image Received: ${file.name}**\n\nI can see you've shared an image. For detailed image analysis, please provide the Gemini API key. In the meantime, here are some general tips:\n\n‚Ä¢ If this shows disaster damage, stay safe and contact authorities\n‚Ä¢ Document important information for insurance claims\n‚Ä¢ Share with emergency services if immediate help is needed\n\nüí° **Note:** With Gemini API, I can provide detailed analysis of what I see in your image.`;
                } else if (file.type.startsWith('video/')) {
                    response = `üé• **Video Received: ${file.name}**\n\nI've received your video file. For detailed video analysis, please provide the Gemini API key. General guidance:\n\n‚Ä¢ If this shows an emergency situation, contact 911 immediately\n‚Ä¢ Videos can be valuable evidence for authorities\n‚Ä¢ Ensure your safety before recording in dangerous situations\n\nüí° **Note:** With Gemini API, I can analyze video content and provide specific guidance.`;
                } else if (file.type === 'application/pdf') {
                    response = `üìÑ **PDF Document Received: ${file.name}**\n\nI've received your PDF document. For detailed document analysis, please provide the Gemini API key. In the meantime:\n\n‚Ä¢ If this contains emergency information, please share key details in text\n‚Ä¢ I can help interpret standard emergency procedures\n‚Ä¢ For immediate guidance, describe your situation in text\n\nüí° **Note:** With Gemini API, I can read and analyze your PDF content directly.`;
                }
                
                addMessage(response, 'ai');
                updateChatHistory(`[File: ${file.name}]`, response);
            }, 1000 + Math.random() * 500);
        }
        
        function getGeminiPrompt(fileType) {
            if (fileType.startsWith('image/')) {
                return "You are DisasterAI, an emergency support assistant. Analyze this image and provide helpful guidance. If you see any signs of disaster, damage, flooding, fire, or emergency situations, provide specific safety advice. If it's a preparedness-related image, offer relevant tips. Be supportive, practical, and focus on safety. Keep responses concise but helpful.";
            } else if (fileType.startsWith('video/')) {
                return "You are DisasterAI, an emergency support assistant. Analyze this video and provide helpful guidance. Look for any signs of disaster, emergency situations, safety procedures, or preparedness activities. Provide specific, actionable advice based on what you observe. Be supportive and focus on safety. Keep responses concise but comprehensive.";
            } else if (fileType === 'application/pdf') {
                return "You are DisasterAI, an emergency support assistant. Analyze this PDF document and provide helpful guidance. If it contains emergency procedures, disaster plans, safety information, or preparedness materials, summarize key points and offer additional relevant advice. Be supportive and practical. Keep responses concise but informative.";
            }
            return "You are DisasterAI, an emergency support assistant. Analyze this file and provide helpful guidance related to disaster preparedness, emergency response, or safety. Be supportive and practical.";
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // Function to set Gemini API key (to be called from outside)
        function setGeminiApiKey(apiKey) {
            geminiApiKey = apiKey;
            console.log('Gemini API key configured');
            
            // Also configure backend if available
            if (backendAvailable) {
                configureBackendApiKey(apiKey);
            }
        }
        
        async function configureBackendApiKey(apiKey) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_key: apiKey
                    })
                });
                
                const data = await response.json();
                console.log('Backend API key configuration:', data);
                
            } catch (error) {
                console.error('Failed to configure backend API key:', error);
            }
        }
        
        // Test functions for debugging and integration testing
        function testIntegration() {
            console.log('=== DisasterAI Integration Test ===');
            console.log('Backend URL:', BACKEND_URL);
            console.log('Backend Available:', backendAvailable);
            console.log('Current Chat ID:', currentChatId);
            console.log('Chat History Length:', chatHistory.length);
            
            // Test user input context creation
            const testContext = {
                message: 'Test message for integration',
                timestamp: new Date().toISOString(),
                inputMethod: 'test',
                sessionId: currentChatId || 'test-session',
                previousContext: getCurrentChatContext()
            };
            
            console.log('Test Context:', testContext);
            
            // Test backend status
            checkBackendStatus().then(status => {
                console.log('Backend Status Check Result:', status);
            });
            
            return {
                backendUrl: BACKEND_URL,
                backendAvailable: backendAvailable,
                testContext: testContext,
                speechRecognitionSupported: !!recognition,
                geminiConfigured: isGeminiAvailable()
            };
        }
        
        // Debug function to simulate user input
        function simulateUserInput(message, inputType = 'text') {
            console.log(`Simulating ${inputType} input:`, message);
            
            const context = {
                message: message,
                timestamp: new Date().toISOString(),
                inputMethod: inputType,
                sessionId: currentChatId || 'sim-' + Date.now(),
                previousContext: getCurrentChatContext()
            };
            
            if (!currentChatId) {
                startNewChat();
            }
            
            addMessage(message, 'user');
            showTypingIndicator();
            
            if (backendAvailable) {
                processMessageWithBackend(context);
            } else {
                setTimeout(() => {
                    hideTypingIndicator();
                    const response = generateAIResponse(message, context);
                    addMessage(response, 'ai');
                    updateChatHistory(message, response);
                }, 1000);
            }
        }
        
        // Make test functions globally accessible
        window.testIntegration = testIntegration;
        window.simulateUserInput = simulateUserInput;
        window.checkBackendStatus = checkBackendStatus;
        
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Hide empty state
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Create new chat if needed
            if (!currentChatId) {
                startNewChat();
            }
            
            // Capture additional context for enhanced processing
            const userInputContext = {
                message: message,
                timestamp: new Date().toISOString(),
                inputMethod: 'text', // Can be 'text', 'voice', or 'suggestion'
                sessionId: currentChatId,
                previousContext: getCurrentChatContext()
            };
            
            // Add user message to UI
            addMessage(message, 'user');
            
            // Clear input and reset state
            messageInput.value = '';
            currentMessage = '';
            handleInputChange();
            
            // Show typing indicator
            showTypingIndicator();
            
            // Process message with enhanced context
            if (backendAvailable) {
                processMessageWithBackend(userInputContext);
            } else {
                // Fallback to local responses with context awareness
                setTimeout(() => {
                    hideTypingIndicator();
                    const response = generateAIResponse(message, userInputContext);
                    addMessage(response, 'ai');
                    updateChatHistory(message, response);
                }, 1500 + Math.random() * 1000);
            }
        }
        
        // Enhanced backend communication with proper context and error handling
        async function processMessageWithBackend(userInputContext) {
            try {
                // Prepare the request payload with enhanced context
                const requestPayload = {
                    message: userInputContext.message,
                    context: {
                        inputMethod: userInputContext.inputMethod,
                        sessionId: userInputContext.sessionId,
                        timestamp: userInputContext.timestamp,
                        previousContext: userInputContext.previousContext,
                        userAgent: navigator.userAgent,
                        chatLength: userInputContext.previousContext?.messageCount || 0
                    },
                    // Add any user preferences or settings
                    preferences: {
                        responseStyle: 'supportive', // Could be configurable
                        urgencyDetection: true,
                        psychologicalSupport: true
                    }
                };
                
                console.log('Sending to backend:', requestPayload);
                
                const response = await fetch(`${BACKEND_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestPayload),
                    // Add timeout to prevent hanging requests
                    signal: AbortSignal.timeout(30000) // 30 second timeout
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                hideTypingIndicator();
                
                if (data.success) {
                    // Enhanced response handling with metadata
                    const enhancedResponse = data.response;
                    addMessage(enhancedResponse, 'ai');
                    updateChatHistory(userInputContext.message, enhancedResponse);
                    
                    // Log successful interaction for analytics
                    console.log('Backend response received:', {
                        messageType: data.message_type,
                        hasFiles: data.has_files,
                        timestamp: data.timestamp,
                        inputMethod: userInputContext.inputMethod
                    });
                } else {
                    throw new Error(data.error || 'Backend processing failed');
                }
                
            } catch (error) {
                console.error('Backend communication error:', error);
                hideTypingIndicator();
                
                // Enhanced error handling with specific fallback messages
                let fallbackMessage;
                if (error.name === 'AbortError' || error.message.includes('timeout')) {
                    fallbackMessage = '‚è∞ **Server Status: Request Timeout**\n\nThe server is taking longer than expected to respond:\n\n‚Ä¢ High server load\n‚Ä¢ Network congestion\n‚Ä¢ Processing complex request\n\nüí° **What you can do:**\n‚Ä¢ Try a simpler question\n‚Ä¢ Wait a moment and try again\n‚Ä¢ Check your internet connection\n\n**Emergency Note:** For immediate emergencies, contact 911 directly.\n\n---\n\n**Local Response:** ';
                } else if (error.message.includes('fetch') || error.message.includes('NetworkError')) {
                    fallbackMessage = 'üîå **Server Status: Connection Failed**\n\nCannot connect to the backend server:\n\n‚Ä¢ Server may be offline\n‚Ä¢ Network connectivity issues\n‚Ä¢ Firewall blocking connection\n\nüí° **Troubleshooting:**\n‚Ä¢ Check if backend server is running\n‚Ä¢ Verify network connection\n‚Ä¢ Try refreshing the page\n\n**Emergency Note:** For urgent help, contact emergency services directly.\n\n---\n\n**Local Response:** ';
                } else if (error.message.includes('500') || error.message.includes('Internal Server Error')) {
                    fallbackMessage = '‚ö†Ô∏è **Server Status: Internal Server Error**\n\nThe server encountered an internal error:\n\n‚Ä¢ Server-side processing issue\n‚Ä¢ Database connection problems\n‚Ä¢ Service configuration error\n\nüí° **Next steps:**\n‚Ä¢ Try again in a few minutes\n‚Ä¢ Contact technical support\n‚Ä¢ Use local responses for now\n\n**Emergency Note:** For emergencies, call 911 immediately.\n\n---\n\n**Local Response:** ';
                } else if (error.message.includes('503') || error.message.includes('Service Unavailable')) {
                    fallbackMessage = 'üîß **Server Status: Service Temporarily Unavailable**\n\nThe server is temporarily down for maintenance:\n\n‚Ä¢ Scheduled maintenance in progress\n‚Ä¢ System updates being applied\n‚Ä¢ Service restart required\n\nüí° **Expected resolution:**\n‚Ä¢ Service should resume shortly\n‚Ä¢ Check back in 10-15 minutes\n‚Ä¢ Monitor service status\n\n**Emergency Note:** For immediate assistance, contact emergency services.\n\n---\n\n**Local Response:** ';
                } else {
                    fallbackMessage = '‚ùå **Server Status: Communication Error**\n\nAn unexpected error occurred while contacting the server:\n\n‚Ä¢ Unknown connection issue\n‚Ä¢ Server configuration problem\n‚Ä¢ Service disruption\n\nüí° **Recommended actions:**\n‚Ä¢ Refresh the page and try again\n‚Ä¢ Check server status\n‚Ä¢ Contact support if problem persists\n\n**Emergency Note:** For urgent situations, contact emergency services directly.\n\n---\n\n**Local Response:** ';
                }
                
                // Generate enhanced local response with context
                const localResponse = generateAIResponse(userInputContext.message, userInputContext);
                addMessage(fallbackMessage + localResponse, 'ai');
                updateChatHistory(userInputContext.message, fallbackMessage + localResponse);
            }
        }
        
        // Enhanced function to capture current chat context
        function getCurrentChatContext() {
            if (!currentChatId) return null;
            
            const currentChat = chatHistory.find(c => c.id === currentChatId);
            if (!currentChat || !currentChat.messages) return null;
            
            // Get last few messages for context (max 5 messages or 1000 characters)
            const recentMessages = currentChat.messages.slice(-5);
            const contextSummary = recentMessages.map(msg => {
                const role = msg.type || msg.role;
                const content = msg.content.length > 200 ? msg.content.substring(0, 200) + '...' : msg.content;
                return `${role}: ${content}`;
            }).join('\n');
            
            return {
                messageCount: currentChat.messages.length,
                recentMessages: contextSummary,
                chatTitle: currentChat.title
            };
        }
        
        // Enhanced suggestion sending with context
        function sendSuggestion(message) {
            messageInput.value = message;
            
            // Mark as suggestion input for context
            const suggestionContext = {
                message: message,
                timestamp: new Date().toISOString(),
                inputMethod: 'suggestion',
                sessionId: currentChatId,
                previousContext: getCurrentChatContext()
            };
            
            // Hide empty state
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Create new chat if needed
            if (!currentChatId) {
                startNewChat();
            }
            
            // Add user message to UI
            addMessage(message, 'user');
            
            // Clear input
            messageInput.value = '';
            currentMessage = '';
            handleInputChange();
            
            // Show typing indicator
            showTypingIndicator();
            
            // Process with enhanced context
            if (backendAvailable) {
                processMessageWithBackend(suggestionContext);
            } else {
                setTimeout(() => {
                    hideTypingIndicator();
                    const response = generateAIResponse(message, suggestionContext);
                    addMessage(response, 'ai');
                    updateChatHistory(message, response);
                }, 1500 + Math.random() * 1000);
            }
        }
        
        function addMessage(content, type) {
            const messagesDiv = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Process content based on type
            let processedContent = content;
            if (type === 'ai') {
                // For AI messages, convert markdown to HTML
                try {
                    // Configure marked for better formatting
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        sanitize: false,
                        smartLists: true,
                        smartypants: true
                    });
                    processedContent = marked.parse(content);
                } catch (error) {
                    console.warn('Markdown parsing error:', error);
                    // Fallback: basic markdown processing
                    processedContent = content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/\n/g, '<br>')
                        .replace(/#{3}\s+(.*)/g, '<h3>$1</h3>')
                        .replace(/#{2}\s+(.*)/g, '<h2>$1</h2>')
                        .replace(/#{1}\s+(.*)/g, '<h1>$1</h1>')
                        .replace(/- (.*)/g, '<li>$1</li>')
                        .replace(/(\<li\>.*\<\/li\>)/g, '<ul>$1</ul>');
                }
            } else {
                // For user messages, keep as plain text but handle line breaks
                processedContent = content.replace(/\n/g, '<br>');
            }
            
            // Create unique ID for copy functionality
            const messageId = Date.now() + Math.random().toString(36).substr(2, 9);
            
            // Add copy button for AI messages
            const copyButton = type === 'ai' ? `
                <button class="copy-btn" onclick="copyMessage('${messageId}')" title="Copy message">
                    <i class="fas fa-copy"></i>
                </button>
            ` : '';
            
            messageDiv.innerHTML = `
                <div class="message-avatar ${type}-avatar">
                    <i class="fas fa-${type === 'user' ? 'user' : 'robot'}"></i>
                </div>
                <div class="message-content">
                    <div class="message-text" id="${messageId}">
                        ${processedContent}
                        ${copyButton}
                    </div>
                    <div class="message-time">${timeString}</div>
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Copy message functionality
        function copyMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;
            
            // Get the text content, excluding the copy button
            const copyButton = messageElement.querySelector('.copy-btn');
            if (copyButton) {
                copyButton.style.display = 'none';
            }
            
            // Get the text content
            let textToCopy = messageElement.innerText || messageElement.textContent;
            
            // Show the copy button again
            if (copyButton) {
                copyButton.style.display = 'flex';
            }
            
            // Clean up the text (remove extra whitespace)
            textToCopy = textToCopy.trim();
            
            // Copy to clipboard
            if (navigator.clipboard && window.isSecureContext) {
                // Modern async clipboard API
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showCopyFeedback(copyButton);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    // Fallback to execCommand
                    fallbackCopyTextToClipboard(textToCopy, copyButton);
                });
            } else {
                // Fallback for older browsers
                fallbackCopyTextToClipboard(textToCopy, copyButton);
            }
        }
        
        // Fallback copy method for older browsers
        function fallbackCopyTextToClipboard(text, button) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            
            // Avoid scrolling to bottom
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyFeedback(button);
                } else {
                    console.error('Fallback copy failed');
                }
            } catch (err) {
                console.error('Fallback copy error: ', err);
            }
            
            document.body.removeChild(textArea);
        }
        
        // Show visual feedback when text is copied
        function showCopyFeedback(button) {
            if (!button) return;
            
            const originalIcon = button.innerHTML;
            const originalClass = button.className;
            
            // Change to checkmark and green color
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.classList.add('copied');
            
            // Reset after 2 seconds
            setTimeout(() => {
                button.innerHTML = originalIcon;
                button.className = originalClass;
            }, 2000);
        }
        
        function showTypingIndicator() {
            const messagesDiv = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="message-avatar ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // Enhanced AI response generation with context awareness
        function generateAIResponse(userMessage, userInputContext = null) {
            // Enhanced response logic that considers context
            const lowerMessage = userMessage.toLowerCase();
            
            // Check if this is a follow-up in an ongoing conversation
            const isFollowUp = userInputContext?.previousContext?.messageCount > 0;
            const inputMethod = userInputContext?.inputMethod || 'text';
            
            // Context-aware response prefix based on input method
            let responsePrefix = '';
            if (inputMethod === 'voice') {
                responsePrefix = 'üé§ **Voice Input Received** | ';
            } else if (inputMethod === 'suggestion') {
                responsePrefix = 'üí° **Quick Response** | ';
            } else if (isFollowUp) {
                responsePrefix = 'üîÑ **Follow-up** | ';
            }
            
            // Enhanced response categories with context awareness
            const responses = {
                flood: [
                    "üåä For flood safety: Move to higher ground immediately, avoid walking or driving through flood water, and listen to emergency broadcasts. Stay safe!",
                    "During a flood, remember: Turn around, don't drown! Just 6 inches of moving water can knock you down, and 12 inches can carry away a vehicle.",
                    "üö® Flood emergency steps:\n1. Get to higher ground\n2. Avoid flooded roads\n3. Stay informed via radio\n4. Have emergency supplies ready\n\nDo you need specific evacuation guidance?"
                ],
                anxiety: [
                    "üòå I understand you're feeling anxious. Try this breathing exercise: Breathe in for 4 counts, hold for 4, exhale for 6. Repeat 5 times. You're not alone in this.",
                    "ü§ó Anxiety during disasters is completely normal. Focus on what you can control: your safety, breathing, and staying informed. Would you like some grounding techniques?",
                    "üíô It's okay to feel overwhelmed. Here are some immediate coping strategies:\n‚Ä¢ Deep breathing\n‚Ä¢ 5-4-3-2-1 grounding technique\n‚Ä¢ Stay hydrated\n‚Ä¢ Connect with loved ones\n\nHow are you feeling right now?"
                ],
                emergency: [
                    "üÜò For immediate emergencies, call 911 right away. If you're in immediate danger:\n1. Get to safety first\n2. Call emergency services\n3. Follow official evacuation orders\n\nWhat's your current situation?",
                    "üö® Emergency priorities:\n1. Ensure personal safety\n2. Call 911 if needed\n3. Follow official guidance\n4. Stay informed\n\nAre you currently in a safe location?",
                    "‚ö†Ô∏è If this is a life-threatening emergency, please call 911 immediately. For non-emergency support, I'm here to help with guidance and resources."
                ],
                preparedness: [
                    "üéí Emergency preparedness essentials:\n‚Ä¢ 72-hour emergency kit\n‚Ä¢ First aid supplies\n‚Ä¢ Important documents\n‚Ä¢ Emergency contacts list\n‚Ä¢ Flashlight & batteries\n\nWould you like details on any of these?",
                    "üìã Great question! Start with these basics:\n1. Emergency kit with food/water\n2. Communication plan\n3. Important documents copies\n4. First aid knowledge\n\nWhat type of disasters are most common in your area?",
                    "üè† Home preparedness checklist:\n‚úì Emergency supplies\n‚úì Evacuation plan\n‚úì Important documents\n‚úì Emergency contacts\n‚úì First aid kit\n\nLet's work on your family emergency plan!"
                ],
                firstaid: [
                    "üè• Basic first aid priorities:\n1. Check for responsiveness\n2. Call for help if needed\n3. Control bleeding\n4. Treat for shock\n\nWhat specific first aid situation do you need help with?",
                    "ü©π First aid basics everyone should know:\n‚Ä¢ CPR and AED use\n‚Ä¢ Wound care\n‚Ä¢ Choking response\n‚Ä¢ Shock treatment\n\nWould you like step-by-step instructions for any of these?",
                    "‚öïÔ∏è Remember the first aid ABCs:\n‚Ä¢ Airway - keep it clear\n‚Ä¢ Breathing - check and assist\n‚Ä¢ Circulation - control bleeding\n\nDo you need guidance for a specific injury or emergency?"
                ],
                followup: [
                    "I'm here to continue helping you. What else would you like to know?",
                    "Based on our conversation, is there anything specific you'd like me to clarify or expand on?",
                    "How can I further assist you with your disaster preparedness or safety concerns?"
                ]
            };
            
            let selectedResponse = '';
            
            if (lowerMessage.includes('flood') || lowerMessage.includes('water')) {
                selectedResponse = responses.flood[Math.floor(Math.random() * responses.flood.length)];
            } else if (lowerMessage.includes('anxious') || lowerMessage.includes('stress') || lowerMessage.includes('worried') || lowerMessage.includes('scared')) {
                selectedResponse = responses.anxiety[Math.floor(Math.random() * responses.anxiety.length)];
            } else if (lowerMessage.includes('emergency') || lowerMessage.includes('help') || lowerMessage.includes('immediate')) {
                selectedResponse = responses.emergency[Math.floor(Math.random() * responses.emergency.length)];
            } else if (lowerMessage.includes('preparedness') || lowerMessage.includes('prepare') || lowerMessage.includes('kit') || lowerMessage.includes('plan')) {
                selectedResponse = responses.preparedness[Math.floor(Math.random() * responses.preparedness.length)];
            } else if (lowerMessage.includes('first aid') || lowerMessage.includes('medical') || lowerMessage.includes('injury') || lowerMessage.includes('wound')) {
                selectedResponse = responses.firstaid[Math.floor(Math.random() * responses.firstaid.length)];
            } else if (isFollowUp && (lowerMessage.includes('more') || lowerMessage.includes('else') || lowerMessage.length < 20)) {
                selectedResponse = responses.followup[Math.floor(Math.random() * responses.followup.length)];
            } else {
                // Default enhanced response
                selectedResponse = "I'm here to help you with disaster preparedness, emergency guidance, and psychological support. Could you tell me more about what specific assistance you need? Whether it's safety information, stress management, or emergency planning, I'm ready to help! ü§ñüíô\n\nüí° **Tip:** You can also upload images, videos, or PDFs for detailed analysis (requires Gemini API key).";
            }
            
            // Add context-aware enhancements
            if (userInputContext?.previousContext?.chatTitle && isFollowUp) {
                selectedResponse += `\n\nüîó *Continuing our discussion about: ${userInputContext.previousContext.chatTitle}*`;
            }
            
            // Add input method acknowledgment for voice input
            if (inputMethod === 'voice') {
                selectedResponse = "üé§ I understood your voice message. " + selectedResponse;
            }
            
            return responsePrefix + selectedResponse;
        }
        
        function startNewChat() {
            currentChatId = Date.now().toString();
            chatTitle.textContent = 'New Chat';
            
            // Clear message input
            const messageInput = document.getElementById('messageInput');
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Clear messages and show empty state
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = `
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="empty-title">How can I help you today?</div>
                    <div class="empty-subtitle">Ask me about disaster preparedness, emergency situations, or if you need psychological support. Upload images, videos, or PDFs for specialized analysis with enhanced AI prompts.</div>
                    
                    <div class="suggestion-chips">
                        <div class="chip" onclick="sendSuggestion('I am feeling anxious about disaster')">üò∞ Feeling Anxious</div>
                        <div class="chip" onclick="sendSuggestion('Emergency preparedness tips')">üéí Preparedness</div>
                        <div class="chip" onclick="sendSuggestion('First aid guidance')">üè• First Aid</div>
                    </div>
                </div>
            `;
            
            // Update chat history UI to show active state
            renderChatHistory();
            
            // Enable send button state
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
        }
        
        function updateChatHistory(userMessage, aiResponse) {
            if (!currentChatId) return;
            
            // Find existing chat or create new one
            let chat = chatHistory.find(c => c.id === currentChatId);
            if (!chat) {
                chat = {
                    id: currentChatId,
                    title: userMessage.substring(0, 50) + (userMessage.length > 50 ? '...' : ''),
                    messages: [],
                    timestamp: new Date().toISOString()
                };
                chatHistory.unshift(chat);
            }
            
            // Add messages
            chat.messages.push(
                { type: 'user', content: userMessage, timestamp: new Date().toISOString() },
                { type: 'ai', content: aiResponse, timestamp: new Date().toISOString() }
            );
            
            // Update title if this is the first exchange
            if (chat.messages.length === 2) {
                chat.title = userMessage.substring(0, 50) + (userMessage.length > 50 ? '...' : '');
                chatTitle.textContent = chat.title;
            }
            
            // Save to localStorage
            localStorage.setItem('disasterAI_chatHistory', JSON.stringify(chatHistory));
            
            // Re-render history
            renderChatHistory();
        }
        
        function renderChatHistory() {
            const historyContainer = document.getElementById('chatHistory');
            
            if (chatHistory.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">
                        No chat history yet. Start a conversation!
                    </div>
                `;
                return;
            }
            
            historyContainer.innerHTML = chatHistory.map(chat => {
                // Handle both old and new chat format
                const date = new Date(chat.lastUpdate || chat.timestamp || chat.startTime);
                const timeString = date.toLocaleDateString() === new Date().toLocaleDateString() 
                    ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    : date.toLocaleDateString();
                
                // Get preview from first user message
                let preview = '';
                if (chat.messages && chat.messages.length > 0) {
                    const firstUserMsg = chat.messages.find(msg => msg.type === 'user' || msg.role === 'user');
                    if (firstUserMsg) {
                        preview = firstUserMsg.content.substring(0, 60) + (firstUserMsg.content.length > 60 ? '...' : '');
                    } else {
                        preview = chat.messages[0].content.substring(0, 60) + (chat.messages[0].content.length > 60 ? '...' : '');
                    }
                } else {
                    preview = 'New conversation';
                }
                
                // Add source indicator for popup chats
                const sourceIndicator = chat.source === 'popup' ? ' <span style="color: var(--primary); font-size: 11px;">üì± Popup</span>' : '';
                
                return `
                    <div class="history-item ${chat.id === currentChatId ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                        <div class="history-content">
                            <div class="history-title" id="title-${chat.id}">${chat.title}${sourceIndicator}</div>
                            <div class="history-preview">${preview}</div>
                            <div class="history-time">${timeString}</div>
                        </div>
                        <button class="edit-chat-btn" onclick="editChatName('${chat.id}', event)" title="Rename chat">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-chat-btn" onclick="deleteChat('${chat.id}', event)" title="Delete chat">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        function loadChat(chatId) {
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;
            
            currentChatId = chatId;
            chatTitle.textContent = chat.title;
            
            // Clear messages
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';
            
            // Load messages - handle both old and new format
            if (chat.messages && chat.messages.length > 0) {
                chat.messages.forEach(message => {
                    // Handle popup chatbot format (type) vs full chatbot format (role)
                    const messageType = message.type || message.role;
                    // Convert 'bot' to 'ai' for consistency
                    const displayType = messageType === 'bot' ? 'ai' : messageType;
                    addMessage(message.content, displayType);
                });
            }
            
            // Hide empty state
            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Update active state in history
            renderChatHistory();
        }
        
        // Search functionality
        function toggleSearch() {
            const searchContainer = document.getElementById('searchContainer');
            const searchInput = document.getElementById('searchInput');
            
            if (searchContainer.style.display === 'none') {
                searchContainer.style.display = 'block';
                searchInput.focus();
            } else {
                searchContainer.style.display = 'none';
                searchInput.value = '';
                renderChatHistory(); // Reset to show all chats
            }
        }
        
        function searchChats() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const historyContainer = document.getElementById('chatHistory');
            
            if (!searchTerm) {
                renderChatHistory();
                return;
            }
            
            const filteredChats = chatHistory.filter(chat => {
                const title = chat.title.toLowerCase();
                const content = chat.messages.map(m => m.content.toLowerCase()).join(' ');
                return title.includes(searchTerm) || content.includes(searchTerm);
            });
            
            if (filteredChats.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">
                        No chats found for "${searchTerm}"
                    </div>
                `;
                return;
            }
            
            historyContainer.innerHTML = filteredChats.map(chat => {
                const date = new Date(chat.timestamp);
                const timeString = date.toLocaleDateString() === new Date().toLocaleDateString() 
                    ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    : date.toLocaleDateString();
                
                const preview = chat.messages[0]?.content.substring(0, 60) + (chat.messages[0]?.content.length > 60 ? '...' : '') || 'New conversation';
                
                return `
                    <div class="history-item ${chat.id === currentChatId ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                        <div class="history-content">
                            <div class="history-title" id="title-${chat.id}">${chat.title}</div>
                            <div class="history-preview">${preview}</div>
                            <div class="history-time">${timeString}</div>
                        </div>
                        <button class="edit-chat-btn" onclick="editChatName('${chat.id}', event)" title="Rename chat">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-chat-btn" onclick="deleteChat('${chat.id}', event)" title="Delete chat">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // Edit chat name functionality
        function editChatName(chatId, event) {
            // Prevent triggering the loadChat function
            event.stopPropagation();
            
            // Find the chat in history
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;
            
            // Prompt for new name
            const newName = prompt('Enter new chat name:', chat.title);
            if (newName && newName.trim() && newName.trim() !== chat.title) {
                // Update the chat title
                chat.title = newName.trim();
                
                // Update localStorage
                localStorage.setItem('disasterAI_chatHistory', JSON.stringify(chatHistory));
                
                // Update the current chat title if this is the active chat
                if (currentChatId === chatId) {
                    const chatTitle = document.getElementById('chatTitle');
                    chatTitle.textContent = chat.title;
                }
                
                // Refresh the history display
                renderChatHistory();
            }
        }
        
        // Delete chat functionality
        function deleteChat(chatId, event) {
            // Prevent triggering the loadChat function
            event.stopPropagation();
            
            // Confirm deletion
            if (confirm('Are you sure you want to delete this chat?')) {
                // Remove from chatHistory array
                chatHistory = chatHistory.filter(chat => chat.id !== chatId);
                
                // Update localStorage
                localStorage.setItem('disasterAI_chatHistory', JSON.stringify(chatHistory));
                
                // If the deleted chat was the current one, start a new chat
                if (currentChatId === chatId) {
                    startNewChat();
                } else {
                    // Just refresh the history display
                    renderChatHistory();
                }
            }
        }
        
        // Load User Information from MongoDB database
        async function loadUserInfo() {
            try {
                // First try to get user data from session/localStorage
                let userData = null;
                
                // Check localStorage for stored user data
                const localData = localStorage.getItem('resq_user') || localStorage.getItem('currentUser') || localStorage.getItem('user');
                if (localData) {
                    userData = JSON.parse(localData);
                }
                
                // If no local data or token exists, try to fetch from backend
                const token = localStorage.getItem('token') || localStorage.getItem('authToken') || localStorage.getItem('jwt');
                if (!userData && token) {
                    try {
                        const response = await fetch('http://localhost:5000/api/auth/current', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.ok) {
                            userData = await response.json();
                            // Save to localStorage for future use
                            localStorage.setItem('resq_user', JSON.stringify(userData));
                        } else {
                            console.log('Failed to fetch user from backend:', response.status);
                        }
                    } catch (fetchError) {
                        console.log('Could not fetch user from backend:', fetchError.message);
                    }
                }
                
                if (userData) {
                    const firstName = userData.firstName || userData.name || userData.username || userData.email?.split('@')[0] || 'User';
                    const lastName = userData.lastName || '';
                    const fullName = lastName ? `${firstName} ${lastName}` : firstName;
                    
                    // Update sidebar user profile
                    const userNameElement = document.getElementById('userName');
                    const userAvatarElement = document.getElementById('userAvatar');
                    
                    if (userNameElement) userNameElement.textContent = fullName;
                    if (userAvatarElement) userAvatarElement.textContent = firstName.charAt(0).toUpperCase();
                    
                    console.log('User loaded:', fullName);
                } else {
                    // Fallback to default values
                    console.log('No user data found');
                    setDefaultUser();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                setDefaultUser();
            }
        }

        function setDefaultUser() {
            const userNameElement = document.getElementById('userName');
            const userAvatarElement = document.getElementById('userAvatar');
            
            if (userNameElement) userNameElement.textContent = 'Guest User';
            if (userAvatarElement) userAvatarElement.textContent = 'G';
        }
        
        // User profile functionality
        function initializeUserProfile() {
            loadUserInfo();
            
            // Add hover effect for user profile section (no click redirect)
            const userProfile = document.querySelector('.user-profile');
            if (userProfile) {
                userProfile.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                });
                
                userProfile.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'transparent';
                });
            }
            
            // Refresh user data every 5 minutes
            setInterval(loadUserInfo, 5 * 60 * 1000);
        }
        
        // Handle window resize for mobile
        window.addEventListener('resize', function() {
            // Adjust layout for mobile devices
            if (window.innerWidth <= 640) {
                // Mobile specific adjustments can be added here
            }
        });
        
        // Dashboard Sidebar functionality
        function toggleDashboardSidebar() {
            const sidebar = document.getElementById('dashboardSidebar');
            const hamburgerMenu = document.getElementById('hamburgerMenu');
            const overlay = document.getElementById('dashboardOverlay');
            
            sidebar.classList.toggle('open');
            hamburgerMenu.classList.toggle('active');
            overlay.classList.toggle('show');
        }
        
        // Close dashboard sidebar function
        function closeDashboardSidebar() {
            const sidebar = document.getElementById('dashboardSidebar');
            const hamburgerMenu = document.getElementById('hamburgerMenu');
            const overlay = document.getElementById('dashboardOverlay');
            
            sidebar.classList.remove('open');
            hamburgerMenu.classList.remove('active');
            overlay.classList.remove('show');
        }
        
        // Navigation function
        function navigateTo(page) {
            // Show loading indicator
            showLoadingIndicator();
            
            // Add smooth transition
            document.body.style.opacity = '0.8';
            document.body.style.transition = 'opacity 0.3s ease';
            
            setTimeout(() => {
                try {
                    window.location.href = page;
                } catch (error) {
                    console.error('Navigation error:', error);
                    hideLoadingIndicator();
                    alert('‚ö†Ô∏è Navigation Error\n\nSorry, the page is currently unavailable.');
                    document.body.style.opacity = '1';
                }
            }, 300);
        }
        
        function showLoadingIndicator() {
            // Create loading overlay if it doesn't exist
            if (!document.getElementById('loadingOverlay')) {
                const loadingHTML = `
                    <div id="loadingOverlay" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(26, 115, 232, 0.9);
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        z-index: 9999;
                        color: white;
                    ">
                        <div style="
                            width: 50px;
                            height: 50px;
                            border: 3px solid rgba(255, 255, 255, 0.3);
                            border-top: 3px solid white;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                            margin-bottom: 20px;
                        "></div>
                        <h3>Loading...</h3>
                        <p>Navigating to your selected page</p>
                    </div>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `;
                document.body.insertAdjacentHTML('beforeend', loadingHTML);
            }
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoadingIndicator() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        // Close dashboard sidebar when clicking outside of it
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('dashboardSidebar');
            const hamburgerMenu = document.getElementById('hamburgerMenu');
            
            // Check if the sidebar is open and the click is outside sidebar and hamburger menu
            if (sidebar && sidebar.classList.contains('open') && 
                !sidebar.contains(event.target) && 
                !hamburgerMenu.contains(event.target)) {
                closeDashboardSidebar();
            }
        });
        
        // Close dashboard sidebar with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const sidebar = document.getElementById('dashboardSidebar');
                if (sidebar && sidebar.classList.contains('open')) {
                    closeDashboardSidebar();
                }
            }
        });
        
        // Initialize dashboard sidebar as closed by default
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('dashboardSidebar');
            const overlay = document.getElementById('dashboardOverlay');
            if (sidebar) sidebar.classList.remove('open');
            if (overlay) overlay.classList.remove('show');
        });
    </script>
</body>
</html>