<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DisasterSafe - Student Dashboard (Improved UI)</title>

    <!-- Font Awesome and Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <link
        href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --primary: #1a73e8;
            /* original blue navbar */
            --primary-dark: #0d47a1;
            --secondary: #34a853;
            --accent: #f25c54;
            --warning: #f9a825;
            --card-bg: #ffffff;
            --text-dark: #202124;
            --light-bg: #f5f7fb;

            /* user palette to use across cards/overlays */
            --p1: #309ad4;
            --p2: #e69c42;
            --p3: #ea8d99;
            --p4: #faafa4;
            --p5: #e2afd3;
            --p6: #c8e5f3;
            --p7: #fae8c7;

            --shadow: 0 8px 20px rgba(18, 38, 63, 0.08);
            --transition: all 0.25s ease;
            --glass: rgba(255, 255, 255, 0.72);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            /* font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; */
        }

        body {
            background: var(--light-bg);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-family: "Ubuntu", sans-serif;
            font-weight: 400;
            font-style: normal;
        }

        /* Voice Recognition Styles - ADD THIS TO YOUR CSS */
        .voice-recognition {
            text-align: center;
            padding: 20px;
        }

        .voice-status {
            font-size: 16px;
            margin: 15px 0;
            color: #666;
            min-height: 24px;
        }

        .voice-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            font-size: 24px;
            cursor: pointer;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .voice-button.listening {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            animation: pulse 1.5s infinite;
        }

        .voice-button:hover {
            transform: scale(1.05);
        }

        .voice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .voice-transcript {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            min-height: 80px;
            text-align: left;
        }

        .voice-transcript-text {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
        }

        .voice-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .emergency-categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .emergency-category {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .emergency-category:hover {
            border-color: #1a73e8;
            background: #f8f9fa;
        }

        .emergency-category.selected {
            border-color: #1a73e8;
            background: #e3f2fd;
            transform: scale(1.05);
        }

        .alert-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .alert-btn.primary {
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: white;
        }

        .alert-btn:not(.primary) {
            background: #f8f9fa;
            border: 1px solid #ddd;
            color: #333;
        }

        .alert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Layout */
        .dashboard-container {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: linear-gradient(180deg, var(--primary), var(--primary-dark));
            color: #fff;
            padding: 22px;
            position: fixed;
            width: 240px;
            height: 100%;
            overflow-y: auto;
            box-shadow: var(--shadow);
            z-index: 200;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06)
        }

        .logo i {
            font-size: 22px;
            color: var(--p6)
        }

        .logo h1 {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.2px
        }

        .menu-items {
            margin-top: 18px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            color: rgba(255, 255, 255, 0.95)
        }

        .menu-item i {
            width: 20px;
            text-align: center
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.06)
        }

        .menu-item.active {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.06));
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08)
        }

        .new-badge {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #fff;
            margin-left: auto
        }

        /* Main content */
        .main-content {
            grid-column: 2;
            padding: 20px;
            min-height: 100vh
        }

        /* padding-left accounts for fixed sidebar */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            border-radius: 12px;
            /* background: linear-gradient(90deg, var(--primary), var(--primary-dark)); */
            background: transparent;
            color: white;
            box-shadow: var(--shadow);
            gap: 12px;
            flex-wrap: wrap
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.12);
            padding: 8px 12px;
            border-radius: 999px;
            width: 42%;
            min-width: 220px;
            gap: 10px
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: white;
            outline: none;
            width: 100%
        }

        .search-bar .search-btn {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .user-profile img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.15)
        }

        .user-profile h4 {
            font-size: 16px;
            margin-bottom: 2px
        }

        .user-profile p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.85)
        }

        /* language selector aligned right and won't overlap due to header spacing */
        .header-right {
            display: flex;
            justify-content: center;
            align-items: center;
        }


        /* Sidebar User Profile */
        .sidebar-user-profile {
            margin-top: auto;
            padding: 12px;
            margin: 0 -12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
            cursor: pointer;
        }

        .sidebar-user-profile:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--p6), var(--p1));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-dark);
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: white;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-info p {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
        }



        .language-selector select {
            padding: 10px 12px;
            border-radius: 9px;
            border: none;
            background: var(--glass);
            outline: none;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Dashboard grid and cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
            margin: 20px 0 28px
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 18px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(16, 24, 32, 0.03)
        }

        .card:hover {
            transform: translateY(-6px)
        }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 15px
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px
        }

        .stat-info h3 {
            font-size: 20px;
            margin-bottom: 4px
        }

        .stat-info p {
            font-size: 13px;
            color: #6c757d
        }

        /* Emergency button - kept large but improved */
        .emergency-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 25px 20px;
            border-radius: 14px;
            background: linear-gradient(90deg, var(--p3), var(--accent));
            color: white;
            border: none;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(226, 26, 47, 0.12);
            transition: transform .12s ease;
            width: 100%;
            max-width: 350px;
            font-size: 1rem;
        }

        .emergency-button:hover {
            transform: scale(1.02)
        }

        .emergency-button i {
            font-size: 1rem;
        }

        /* Alerts */
        .alerts-section {
            margin-top: 18px
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 22px;
            color: var(--primary);
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(26, 115, 232, 0.08);
            margin-bottom: 12px
        }

        .alert-badge {
            background: var(--p2);
            color: white;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 700
        }

        .alerts-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 420px;
            overflow: auto;
            padding-right: 6px
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 14px;
            border-radius: 12px;
            background: linear-gradient(180deg, #fff, #fbfdff);
            border-left: 5px solid #ddd;
            box-shadow: 0 6px 18px rgba(16, 24, 40, 0.04);
            transition: transform .15s ease, opacity .15s ease
        }

        .alert-item:hover {
            transform: translateX(6px)
        }

        .alert-icon {
            width: 52px;
            height: 52px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px
        }

        .alert-item.severe .alert-icon {
            background: linear-gradient(90deg, var(--p1), var(--accent))
        }

        .alert-item.warning .alert-icon {
            background: linear-gradient(90deg, var(--p2), #ffb95c)
        }

        .alert-item.info .alert-icon {
            background: linear-gradient(90deg, var(--p6), var(--p1))
        }

        .alert-content h4 {
            font-size: 16px;
            margin-bottom: 6px
        }

        .alert-content p {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px
        }

        .alert-meta {
            display: flex;
            gap: 14px;
            font-size: 12px;
            color: #9aa0a6
        }

        .alert-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-left: auto
        }

        .alert-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600
        }

        .alert-btn.primary {
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            color: white;
            border: none
        }

        .alert-btn:disabled {
            opacity: 0.55;
            cursor: default
        }

        /* Attendance */
        .attendance-section {
            margin-top: 20px;
            padding: 20px;
            border-radius: 16px;
            background: linear-gradient(180deg, #fff, #fbfdff);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 14px
        }

        .attendance-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700
        }

        .status-indicator.safe {
            color: var(--secondary)
        }

        .status-indicator.help {
            color: var(--accent)
        }

        .attendance-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap
        }

        .btn-safe,
        .btn-help,
        .btn-location {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 700
        }

        .btn-safe {
            background: linear-gradient(90deg, var(--secondary), #2ea044);
            color: white
        }

        .btn-help {
            background: linear-gradient(90deg, var(--p3), #ea6f7b);
            color: white
        }

        .btn-location {
            background: linear-gradient(90deg, var(--p1), #2f8fc1);
            color: white
        }

        /* Contacts grid */
        .contacts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 12px
        }

        .contact-card {
            border-radius: 14px;
            padding: 16px;
            background: linear-gradient(180deg, #fff, #f7fbff);
            box-shadow: var(--shadow)
        }

        .contact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(26, 115, 232, 0.06);
            margin-bottom: 10px
        }

        .region-status {
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 12px
        }

        .region-status.active {
            background: rgba(52, 168, 83, 0.12);
            color: var(--secondary)
        }

        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(26, 115, 232, 0.03);
            justify-content: space-between;
        }

        .quick-call {
            padding: 8px 12px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(90deg, var(--p1), #2f8fc1);
            color: white;
            font-weight: 700;
            cursor: pointer;
        }

        /* Resources grid (flashcards) - clean and soft */
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            margin-top: 12px
        }

        .resource-card {
            border-radius: 14px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform .18s ease;
            border: 1px solid rgba(16, 24, 40, 0.03)
        }

        .resource-header {
            height: 200px;
            background: linear-gradient(90deg, var(--p6), var(--p1));
            position: relative
        }

        .resource-icon {
            position: absolute;
            bottom: -22px;
            left: 18px;
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: linear-gradient(90deg, var(--p2), #f2b25e);
            color: white;
            box-shadow: 0 10px 18px rgba(16, 24, 40, 0.06)
        }

        .resource-content {
            padding: 34px 18px 20px;
            background: linear-gradient(180deg, #fff, #fff)
        }

        .resource-content h3 {
            margin-bottom: 8px
        }

        .resource-content p {
            color: #6c757d;
            margin-bottom: 12px
        }

        .resource-button {
            display: inline-block;
            padding: 8px 14px;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--p1), #2f8fc1);
            color: white;
            text-decoration: none;
            font-weight: 700
        }

        /* Modals (emergency / details) */
        .modal-overlay {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(6, 12, 30, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1200
        }

        .modal {
            background: linear-gradient(180deg, #fff, #fbfdff);
            border-radius: 14px;
            width: 92%;
            max-width: 720px;
            max-height: 86vh;
            overflow: auto;
            box-shadow: 0 18px 50px rgba(8, 12, 32, 0.25);
            position: relative;
            border: 1px solid rgba(16, 24, 40, 0.04)
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(16, 24, 40, 0.04);
            cursor: grab
        }

        .modal-body {
            padding: 18px;
            overflow-y: auto;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer
        }

        .modal .disaster-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px
        }

        /* draggable cursor while dragging */
        .dragging {
            cursor: grabbing !important
        }

        /* small responsive */
        @media(max-width:992px) {
            .dashboard-container {
                grid-template-columns: 1fr
            }

            .sidebar {
                position: relative;
                width: 100%;
                height: auto
            }

            .main-content {
                padding-left: 18px
            }

            .emergency-button {
                width: 100%
            }
        }

        /* custom scrollbars */
        .alerts-container::-webkit-scrollbar,
        .modal::-webkit-scrollbar {
            height: 10px;
            width: 10px
        }

        .alerts-container::-webkit-scrollbar-thumb,
        .modal::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, var(--p6), var(--p1));
            border-radius: 999px
        }

        .alerts-container::-webkit-scrollbar-track {
            background: transparent
        }

        /* highlight animation */
        @keyframes highlightPulse {
            0% {
                box-shadow: 0 0 0 rgba(48, 154, 212, 0.0)
            }

            50% {
                box-shadow: 0 8px 30px rgba(48, 154, 212, 0.08)
            }

            100% {
                box-shadow: 0 0 0 rgba(48, 154, 212, 0.0)
            }
        }

        .highlight {
            animation: highlightPulse 1100ms ease both;
            border-radius: 12px;
            transform: translateY(-2px)
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <h1>ResQ</h1>
            </div>
            <div class="menu-items">
                <div class="menu-item active"><i class="fas fa-home"></i><span>Dashboard</span></div>
                <div class="menu-item"><i class="fas fa-book"></i><span>Education Modules</span></div>
                <div class="menu-item"><i class="fas fa-gamepad"></i><span>Sandbox Simulator</span></div>
                <div class="menu-item"><i class="fas fa-phone-alt"></i><span>Emergency Contacts</span></div>
                <div class="menu-item"><i class="fa-solid fa-book-open"></i><span>Do's & Dont's</span></div>
                <div class="menu-item"><i class="fa-solid fa-calendar-days"></i><span>Drill Schedule</span></div>
                <div class="menu-item"><i class="fas fa-map-marked-alt"></i><span>Disaster Map</span></div>
                <div class="menu-item"><i class="fas fa-robot"></i><span>AI Helper</span></div>
                <div class="menu-item"><i class="fas fa-graduation-cap"></i><span>Gamified Learning</span></div>
                <!-- <div class="menu-item"><i class="fas fa-user"></i><span>Profile & Badges</span></div> -->
                <div class="menu-item"><i class="fas fa-cog"></i><span>Settings</span></div>
            </div>

            <!-- User Profile at Bottom -->
            <div class="sidebar-user-profile">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <h4 id="sidebarUserName">User</h4>
                    <p>Student</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header-right">
                <button class="emergency-button" id="emergencyBtn"><i class="fas fa-exclamation-triangle"></i>
                    REPORT DISASTER EMERGENCY</button>
            </div>

            <br>
            <!-- Real-time Alerts Section -->
            <section class="alerts-section" id="alertsSection" aria-labelledby="alertsTitle">
                <h1 class="section-title" id="alertsTitle">Real-time Disaster Alerts <span id="alertsCount"
                        class="alert-badge">3</span></h1>
                <div class="alerts-container" id="alertsContainer">
                    <div class="alert-item severe">
                        <div class="alert-icon"><i class="fas fa-bolt"></i></div>
                        <div class="alert-content">
                            <h4>Severe Thunderstorm Warning</h4>
                            <p>Your area is under severe thunderstorm warning. Strong winds and hail expected.</p>
                            <div class="alert-meta"><span class="alert-time">2 minutes ago</span><span
                                    class="alert-region">Delhi NCR</span></div>
                        </div>
                        <div class="alert-actions">
                            <button class="alert-btn primary details-btn">Details</button>
                            <button class="alert-btn mark-read">Mark Read</button>
                        </div>
                    </div>

                    <div class="alert-item warning">
                        <div class="alert-icon"><i class="fas fa-water"></i></div>
                        <div class="alert-content">
                            <h4>Flood Alert - Level 2</h4>
                            <p>Heavy rainfall may cause waterlogging in low-lying areas. Avoid travel if possible.</p>
                            <div class="alert-meta"><span class="alert-time">15 minutes ago</span><span
                                    class="alert-region">Mumbai</span></div>
                        </div>
                        <div class="alert-actions">
                            <button class="alert-btn primary details-btn">Details</button>
                            <button class="alert-btn mark-read">Mark Read</button>
                        </div>
                    </div>

                    <div class="alert-item info">
                        <div class="alert-icon"><i class="fas fa-thermometer-three-quarters"></i></div>
                        <div class="alert-content">
                            <h4>Heat Wave Advisory</h4>
                            <p>Temperature expected to reach 42Â°C. Stay hydrated and avoid outdoor activities.</p>
                            <div class="alert-meta"><span class="alert-time">1 hour ago</span><span
                                    class="alert-region">Rajasthan</span></div>
                        </div>
                        <div class="alert-actions">
                            <button class="alert-btn primary details-btn">Details</button>
                            <button class="alert-btn mark-read">Mark Read</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Attendance -->
            <section class="attendance-section">
                <h2 class="section-title">Disaster Attendance System</h2>
                <div class="attendance-container">
                    <div>
                        <div class="status-indicator safe"><i class="fas fa-check-circle"></i><span>You are marked
                                SAFE</span></div>
                        <br>
                        <div class="last-checkin" style="margin-top:8px;color:#6c757d">Last check-in: Today, 2:30 PM
                        </div>
                    </div>
                    <div class="attendance-actions">
                        <button class="btn-safe" id="btnSafe" onclick="markSafe()">
                            <i class="fas fa-check"></i>
                            I'm Safe
                        </button>
                        <button class="btn-help" id="btnHelp" onclick="requestHelp()">
                            <i class="fas fa-hand-paper"></i>
                            Need Help
                        </button>
                        <button class="btn-location" id="btnLocation" onclick="shareLocation()">
                            <i class="fas fa-map-marker-alt"></i>
                            Share Location
                        </button>
                    </div>
                </div>
            </section>
            <br>

            <!--Stats-->
            <h2 class="section-title">Stats</h2>
            <div class="dashboard-grid" style="margin-top:18px">

                <div class="card stat-card emergency">
                    <div class="stat-icon" style="background:linear-gradient(90deg,var(--p3),#f56b77);color:white"><i
                            class="fas fa-phone-alt"></i></div>
                    <div class="stat-info">
                        <h3>15</h3>
                        <p>Emergency Contacts</p>
                    </div>
                </div>
                <div class="card stat-card preparedness">
                    <div class="stat-icon" style="background:linear-gradient(90deg,var(--p2),#f1a85b);color:white"><i
                            class="fas fa-first-aid"></i></div>
                    <div class="stat-info">
                        <h3>7/10</h3>
                        <p>Preparedness Level</p>
                    </div>
                </div>
                <div class="card stat-card resources">
                    <div class="stat-icon" style="background:linear-gradient(90deg,var(--p6),#8fbfe6);color:white"><i
                            class="fas fa-book"></i></div>
                    <div class="stat-info">
                        <h3>24</h3>
                        <p>Learning Resources</p>
                    </div>
                </div>
            </div>

            <!-- Resources -->
            <h2 class="section-title" style="margin-top:18px">Emergency Resources</h2>
            <div class="resources-grid" id="resourcesGrid">

                <!-- Disaster Education -->
                <div class="resource-card">
                    <div class="resource-header"
                        style="background:url('./images/disater_education.jpg') center/cover no-repeat; height:240px;">
                    </div>
                    <hr>
                    <div class="resource-content">
                        <div class="resource-icon"><i class="fas fa-book"></i></div>
                        <h3>DISASTER EDUCATION</h3>
                        <p>Interactive learning modules for all age groups</p>
                        <a href="/student/education-modules.html" class="resource-button">Explore</a>
                    </div>
                </div>

                <!-- Training Games -->
                <div class="resource-card">
                    <div class="resource-header"
                        style="background:url('./images/training_games.png') center/cover no-repeat; height:240px;">
                    </div>
                    <hr>
                    <div class="resource-content">
                        <div class="resource-icon"><i class="fas fa-gamepad"></i></div>
                        <h3>TRAINING GAMES</h3>
                        <p>Learn disaster management through games</p>
                        <a href="/student/gamified-learning.html" class="resource-button">Play Now</a>
                    </div>
                </div>

                <!-- First Aid Guide -->
                <div class="resource-card">
                    <div class="resource-header"
                        style="background:url('./images/first_aid_guide.png') center/cover no-repeat; height:240px;">
                    </div>
                    <hr>
                    <div class="resource-content">
                        <div class="resource-icon"><i class="fas fa-first-aid"></i></div>
                        <h3>FIRST AID GUIDE</h3>
                        <p>Step-by-step emergency medical instructions</p>
                        <a href="https://www.futurelearn.com/info/blog/fist-aid-basics" class="resource-button"
                            target="_blank">Learn More</a>
                    </div>
                </div>

            </div>
            <br>
            <br>
            <!-- Map -->
            <h1 class="section-title">Disaster Map & Evacuation Routes</h1>
            <div class="card map-container" style="height:420px;padding:0;overflow:hidden">
                <div id="map" style="height:100%;width:100%"></div>
            </div>
        </main>
    </div>

    <!-- Modals appended by JS: emergencyModal and detailsModal -->

    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        /**********************
     * SIMPLE VOICE RECOGNITION (WORKING VERSION)
     **********************/
        function initializeVoiceRecognition() {
            console.log('Initializing voice recognition...');

            // Check browser support first
            if (!('webkitSpeechRecognition' in window)) {
                document.getElementById('voiceStatus').textContent = 'Voice not supported. Use Chrome browser.';
                document.getElementById('voiceButton').disabled = true;
                return;
            }

            const voiceButton = document.getElementById('voiceButton');
            const voiceStatus = document.getElementById('voiceStatus');
            const voiceTranscript = document.getElementById('voiceTranscript');
            const clearVoice = document.getElementById('clearVoice');
            const useVoiceText = document.getElementById('useVoiceText');

            let recognition = new webkitSpeechRecognition();
            let isListening = false;
            let finalTranscript = '';

            // Basic configuration
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            // Event handlers
            // Improved voice status messages
            recognition.onstart = function () {
                isListening = true;
                voiceButton.classList.add('listening');
                voiceStatus.textContent = 'ðŸŽ¤ Listening... Speak clearly about your emergency';
                voiceButton.innerHTML = '<i class="fas fa-stop"></i>';

                // Show speaking tips
                voiceTranscript.textContent = 'Examples: "Water flooding in my area", "Fire in building", "Earthquake shaking"';
            };

            recognition.onresult = function (event) {
                console.log('Voice result received');
                let interimTranscript = '';
                finalTranscript = ''; // âœ… RESET EVERY TIME

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                // âœ… PROPERLY UPDATE THE TRANSCRIPT
                voiceTranscript.textContent = finalTranscript || interimTranscript;

                console.log('Final Transcript:', finalTranscript);
                console.log('Interim Transcript:', interimTranscript);

                // Real-time detection display
                if (finalTranscript.length > 3) {
                    const detectedType = analyzeVoiceTranscript(finalTranscript);
                    voiceStatus.textContent = `ðŸŽ¯ Detected: ${detectedType.toUpperCase()}...`;
                } else if (interimTranscript.length > 3) {
                    const detectedType = analyzeVoiceTranscript(interimTranscript);
                    voiceStatus.textContent = `ðŸŽ¯ Detecting: ${detectedType.toUpperCase()}...`;
                }
            };

            recognition.onerror = function (event) {
                console.error('Voice error:', event.error);
                voiceStatus.textContent = 'Error: ' + event.error;
                stopListening();
            };

            recognition.onend = function () {
                console.log('Voice recognition ended');
                stopListening();
            };

            function stopListening() {
                isListening = false;
                voiceButton.classList.remove('listening');

                // âœ… BETTER STATUS MESSAGE
                if (finalTranscript.trim().length > 0) {
                    voiceStatus.textContent = 'âœ… Voice captured! Click "Use This Text"';
                    voiceStatus.style.color = 'green';
                } else {
                    voiceStatus.textContent = 'Click microphone to speak';
                    voiceStatus.style.color = '#666';
                }

                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            }

            // Button click event - SIMPLE AND WORKING
            voiceButton.addEventListener('click', function () {
                console.log('Microphone clicked');

                if (isListening) {
                    recognition.stop();
                } else {
                    finalTranscript = '';
                    voiceTranscript.textContent = 'Listening...';
                    voiceStatus.textContent = 'ðŸŽ¤ Listening... Speak now!';

                    try {
                        recognition.start();
                    } catch (error) {
                        console.error('Start error:', error);
                        voiceStatus.textContent = 'Error starting voice recognition';
                    }
                }
            });

            // Clear button
            clearVoice.addEventListener('click', function () {
                finalTranscript = '';
                voiceTranscript.textContent = 'Your voice description will appear here...';
                voiceStatus.textContent = 'Click microphone to speak';
            });

            // Use voice text button - IMPROVED VERSION
            useVoiceText.addEventListener('click', function () {
                console.log('Use Text clicked. Final transcript:', finalTranscript);

                // âœ… BETTER CHECK - check both final and displayed text
                const displayedText = voiceTranscript.textContent;
                const hasContent = finalTranscript.trim().length > 0 ||
                    (displayedText && displayedText !== 'Your voice description will appear here...' &&
                        displayedText !== 'Listening...');

                if (hasContent) {
                    const textToUse = finalTranscript.trim() || displayedText;
                    const disasterType = analyzeVoiceTranscript(textToUse);
                    selectedDisasterType = disasterType;

                    console.log('Detected disaster type:', disasterType);

                    // Show selected type
                    document.querySelectorAll('.emergency-category').forEach(cat => {
                        cat.classList.remove('selected');
                        if (cat.dataset.type === disasterType) {
                            cat.classList.add('selected');
                        }
                    });

                    voiceStatus.textContent = `âœ… Detected: ${disasterType.toUpperCase()} emergency`;
                    voiceStatus.style.color = 'green';
                    document.getElementById('confirmEmergency').disabled = false;

                } else {
                    // âœ… BETTER ERROR MESSAGE
                    voiceStatus.textContent = 'âŒ Please speak first or select manually';
                    voiceStatus.style.color = 'red';
                    setTimeout(() => {
                        voiceStatus.textContent = 'Click microphone and describe emergency';
                        voiceStatus.style.color = '#666';
                    }, 3000);
                }
            });

            // Manual category selection - FIXED VERSION
            document.querySelectorAll('.emergency-category').forEach(btn => {
                btn.onclick = () => {
                    selectedDisasterType = btn.dataset.type;
                    document.querySelectorAll('.emergency-category').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');

                    // ALSO UPDATE VOICE STATUS TO SHOW MANUAL SELECTION
                    voiceStatus.textContent = `âœ… Manual: ${selectedDisasterType.toUpperCase()} selected`;
                    voiceStatus.style.color = 'green';

                    // ENABLE SEND BUTTON
                    document.getElementById('confirmEmergency').disabled = false;

                    console.log('Manual selection:', selectedDisasterType); // Debug
                };
            });
        }

        // Simple disaster detection
        // Improved disaster detection - BETTER VERSION
        function analyzeVoiceTranscript(transcript) {
            const text = transcript.toLowerCase();
            console.log('Analyzing text:', text); // Debug

            // More comprehensive keyword matching
            const keywords = {
                flood: [
                    // English Keywords
                    'water', 'flood', 'rain', 'river', 'overflow', 'drown', 'wet', 'flooding',
                    'heavy rain', 'water level', 'monsoon', 'waterlogging', 'inundation',
                    'submerged', 'deluge', 'torrent', 'downpour', 'flash flood',

                    // Common English Phrases
                    'water entering house', 'rainwater coming in', 'river overflowing',
                    'water level rising', 'flood water everywhere', 'heavy rainfall',
                    'house flooded', 'street flooded', 'water logging', 'drain overflow',
                    'basement flooded', 'car stuck in water', 'road underwater',
                    'rescue needed water', 'trapped in water', 'water rising fast',

                    // Hindi/Indian Phrases
                    'paani bhara hua', 'baarish ka pani', 'nadi ka pani', 'ghar mein pani',
                    'sadak par pani', 'baadh aagayi', 'paani badh raha hai', 'ghumne ka pani',
                    'school mein pani', 'college flooded', 'paani andar aa raha hai',
                    'bachao pani mein', 'rescue chahiye pani', 'gaadi pani mein fas gayi',
                    'paani upar aa raha hai', 'monsoon problem', 'rain water entered'
                ],
                fire: [
                    // English Keywords
                    'fire', 'burn', 'smoke', 'flame', 'heat', 'blaze', 'burning', 'explosion',
                    'ignite', 'combustion', 'inferno', 'conflagration', 'spark', 'ember',

                    // Common English Phrases
                    'fire broke out', 'building on fire', 'smoke coming out', 'something burning',
                    'electrical fire', 'gas leak fire', 'kitchen fire', 'forest fire',
                    'fire accident', 'fire emergency', 'fire spreading', 'trapped in fire',
                    'fire alarm', 'fire department', 'rescue from fire', 'evacuate fire',

                    // Hindi/Indian Phrases
                    'aag lag gayi', 'building mein aag', 'smoke aa raha hai', 'kuch jal raha hai',
                    'bijli ki aag', 'gas leak fire', 'rasoi ghar mein aag', 'jungle fire',
                    'aag ka accident', 'fire emergency hai', 'aag fail rahi hai', 'aag mein fas gaye',
                    'bachao aag se', 'fire brigade bulao', 'school mein aag', 'college fire'
                ],
                earthquake: [
                    // English Keywords
                    'earthquake', 'shake', 'tremor', 'ground shaking', 'vibration', 'seismic',
                    'aftershock', 'quake', 'temblor', 'seism', 'richter scale',

                    // Common English Phrases
                    'earthquake happening', 'ground shaking', 'building shaking', 'everything moving',
                    'tremor felt', 'earthquake tremors', 'seismic activity', 'aftershock coming',
                    'building collapse earthquake', 'trapped in building', 'rescue needed earthquake',
                    'evacuate building', 'structural damage', 'walls cracking',

                    // Hindi/Indian Phrases
                    'bhukamp aa raha hai', 'zameen hil rahi hai', 'building hil raha hai',
                    'sab kuch hil raha hai', 'earthquake aaya', 'tremor feel hua',
                    'building collapse hoga', 'building mein fas gaye', 'bachao earthquake se',
                    'school hil raha hai', 'college shaking', 'darwaje band ho gaye',
                    'lift mein fas gaye', 'stairs collapse', 'classroom mein trapped'
                ],
                medical: [
                    // English Keywords
                    'help', 'hurt', 'pain', 'blood', 'accident', 'hospital', 'doctor', 'medical',
                    'injured', 'emergency', 'ambulance', 'first aid', 'unconscious', 'bleeding',
                    'fracture', 'heart attack', 'breathing', 'allergy', 'diabetic', 'asthma',

                    // Common English Phrases
                    'need ambulance', 'medical help', 'someone injured', 'heart attack emergency',
                    'breathing problem', 'unconscious person', 'bleeding heavily', 'bone fracture',
                    'accident happened', 'emergency medical', 'first aid needed', 'trapped injured',
                    'student collapsed', 'teacher fainted', 'food poisoning', 'allergic reaction',

                    // Hindi/Indian Phrases
                    'ambulance chahiye', 'doctor ko bulao', 'first aid chahiye', 'hospital le chalo',
                    'mariz ko help', 'dil ka daura', 'saans nahi aa rahi', 'behoshi ho gayi',
                    'khoon nikal raha hai', 'haddi toot gayi', 'accident ho gaya', 'medical emergency',
                    'bachcha gir gaya', 'teacher behosh', 'school clinic', 'college medical room',
                    'lock room mein fas gaye', 'washroom mein band ho gaye', 'lab accident'
                ],
                storm: [
                    // English Keywords
                    'storm', 'cyclone', 'wind', 'tornado', 'hurricane', 'thunderstorm', 'lightning',
                    'gale', 'tempest', 'squall', 'typhoon', 'whirlwind', 'hailstorm',

                    // Common English Phrases
                    'strong wind', 'storm coming', 'cyclone warning', 'trees falling',
                    'roof blown away', 'power cut', 'heavy storm', 'thunderstorm approaching',
                    'lightning strike', 'storm damage', 'windows breaking', 'flying debris',
                    'trapped in storm', 'rescue needed storm', 'evacuate area',

                    // Hindi/Indian Phrases
                    'toofan aa raha hai', 'tez hawa', 'cyclone warning', 'ped gir rahe hain',
                    'chhat ud gayi', 'bijli chali gayi', 'baarish aur toofan', 'lightning gir rahi hai',
                    'school band karo', 'college close karo', 'andar safe raho', 'bahar mat niklo',
                    'rescue chahiye toofan', 'building safe nahi hai'
                ],
                landslide: [
                    // English Keywords
                    'landslide', 'mudslide', 'rock fall', 'hill collapse', 'mountain slide',
                    'avalanche', 'debris flow', 'mudflow', 'rock slide', 'earth slip',

                    // Common English Phrases
                    'mud sliding', 'hill collapsing', 'rocks falling', 'road blocked landslide',
                    'mountain slide', 'earth movement', 'hill slide', 'trapped in landslide',
                    'rescue needed landslide', 'evacuate hill area', 'house buried',
                    'vehicle stuck landslide',

                    // Hindi/Indian Phrases
                    'landslide ho gaya', 'pahad gira', 'mitti khisak rahi hai', 'pathar gir rahe hain',
                    'sadak band ho gayi', 'pahadi ilaka unsafe', 'ghar daba gaya', 'gaadi fas gayi',
                    'bachao landslide se', 'school ke pass landslide', 'college road blocked'
                ],
                building_collapse: [
                    // English Keywords
                    'building collapse', 'building fall', 'structure collapse', 'wall fall',
                    'roof collapse', 'demolition', 'implosion', 'structural failure',

                    // Common English Phrases
                    'building falling down', 'wall collapsed', 'roof collapse', 'building damage',
                    'structure damage', 'building crack', 'trapped in rubble', 'rescue collapse',
                    'evacuate building', 'school building collapse', 'college structure unsafe',
                    'classroom ceiling fall',

                    // Hindi/Indian Phrases
                    'building gir gayi', 'deewar gir gayi', 'chhat gir gayi', 'building crack ho gayi',
                    'makan toot gaya', 'school building gir rahi hai', 'college unsafe hai',
                    'classroom mein fas gaye', 'rescue chahiye building collapse'
                ], other: [
                    // School/College Specific Emergencies
                    'locked in room', 'trapped in bathroom', 'stuck in lift', 'classroom lock',
                    'laboratory accident', 'chemical spill', 'playground injury', 'sports accident',
                    'bus accident', 'school bus problem', 'ragging emergency', 'bullying help',
                    'electric shock', 'short circuit', 'gas leak school', 'food emergency',

                    // Student Specific Phrases
                    'bachcha kho gaya', 'student missing', 'teacher help needed', 'principal call',
                    'washroom mein band ho gaya', 'library mein lock', 'lab mein accident',
                    'playground mein chot lag gayi', 'school bus breakdown', 'college event emergency',

                    // General Emergency Phrases
                    'kidnapping attempt', 'security threat', 'stranger danger', 'suspicious activity',
                    'fight broke out', 'violence in campus', 'weapon threat', 'bomb scare',

                    // Hindi/Indian Student Phrases
                    'room mein lock ho gaya', 'bathroom mein fas gaya', 'lift band ho gayi',
                    'lab accident ho gaya', 'chemical gir gaya', 'ground mein gir gaya',
                    'school bus kharaab', 'ragging ho rahi hai', 'bachhe ko tang kar rahe hain',
                    'bijli ka shock lag gaya', 'gas leak ho gaya', 'khaana kharab ho gaya',
                    'security help chahiye', 'principal ko bulao emergency'
                ]
            };

            let maxScore = 0;
            let detectedType = 'other';

            // Score each disaster type based on keyword matches
            for (const [type, words] of Object.entries(keywords)) {
                let score = 0;
                words.forEach(word => {
                    if (text.includes(word)) {
                        score += 1;
                    }
                });

                if (score > maxScore) {
                    maxScore = score;
                    detectedType = type;
                }
            }

            // If no strong match, check for emergency words
            if (maxScore === 0) {
                if (text.includes('help') || text.includes('emergency') || text.includes('urgent')) {
                    detectedType = 'medical';
                }
            }

            console.log('Detected type:', detectedType, 'Score:', maxScore); // Debug
            return detectedType;
        }
        // Load User Information from MongoDB database
        async function loadUserInfo() {
            try {
                // First try to get user data from session/localStorage
                let userData = null;

                // Check localStorage for stored user data
                const localData = localStorage.getItem('resq_user') || localStorage.getItem('currentUser') || localStorage.getItem('user');
                if (localData) {
                    userData = JSON.parse(localData);
                }

                // If no local data or token exists, try to fetch from backend
                const token = localStorage.getItem('token') || localStorage.getItem('authToken') || localStorage.getItem('jwt');
                if (!userData && token) {
                    try {
                        const response = await fetch('http://localhost:5000/api/auth/current', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            userData = await response.json();
                            // Save to localStorage for future use
                            localStorage.setItem('resq_user', JSON.stringify(userData));
                        } else {
                            console.log('Failed to fetch user from backend:', response.status);
                        }
                    } catch (fetchError) {
                        console.log('Could not fetch user from backend:', fetchError.message);
                    }
                }

                if (userData) {
                    const firstName = userData.firstName || userData.name || userData.username || userData.email?.split('@')[0] || 'User';
                    const lastName = userData.lastName || '';
                    const fullName = lastName ? `${firstName} ${lastName}` : firstName;

                    // Update sidebar user profile
                    const userNameElement = document.getElementById('sidebarUserName');
                    const userAvatarElement = document.getElementById('userAvatar');

                    if (userNameElement) userNameElement.textContent = fullName;
                    if (userAvatarElement) userAvatarElement.textContent = firstName.charAt(0).toUpperCase();

                    console.log('User loaded:', fullName);
                } else {
                    // Fallback to default values
                    console.log('No user data found');
                    setDefaultUser();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                setDefaultUser();
            }
        }

        function setDefaultUser() {
            const userNameElement = document.getElementById('userName');
            const userPointsElement = document.getElementById('userPoints');

            if (userNameElement) userNameElement.textContent = 'Guest User';
            if (userPointsElement) userPointsElement.textContent = '0';
        }

        // FETCHING POINTS AND USER DATA FROM DATABASE
        window.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();

            // Refresh user data every 5 minutes
            setInterval(loadUserInfo, 5 * 60 * 1000);
        });

        /**********************
         * Utility: make element draggable by header
         * Usage: makeDraggable(modalEl, headerEl)
         **********************/
        function makeDraggable(rootEl, handleEl) {
            let active = false, startX = 0, startY = 0, origX = 0, origY = 0;
            handleEl.style.cursor = 'grab';

            function pointerDown(e) {
                active = true;
                handleEl.classList.add('dragging');
                startX = (e.touches ? e.touches[0].clientX : e.clientX);
                startY = (e.touches ? e.touches[0].clientY : e.clientY);
                const rect = rootEl.getBoundingClientRect();
                origX = rect.left;
                origY = rect.top;
                // set position to fixed if not already
                rootEl.style.position = 'fixed';
                rootEl.style.margin = '0';
                rootEl.style.left = origX + 'px';
                rootEl.style.top = origY + 'px';
                rootEl.style.right = 'auto';
                rootEl.style.bottom = 'auto';
                document.addEventListener('mousemove', pointerMove);
                document.addEventListener('mouseup', pointerUp);
                document.addEventListener('touchmove', pointerMove, { passive: false });
                document.addEventListener('touchend', pointerUp);
            }

            function pointerMove(e) {
                if (!active) return;
                e.preventDefault();
                const x = (e.touches ? e.touches[0].clientX : e.clientX);
                const y = (e.touches ? e.touches[0].clientY : e.clientY);
                const dx = x - startX;
                const dy = y - startY;
                rootEl.style.left = (origX + dx) + 'px';
                rootEl.style.top = (origY + dy) + 'px';
            }

            function pointerUp() {
                active = false;
                handleEl.classList.remove('dragging');
                document.removeEventListener('mousemove', pointerMove);
                document.removeEventListener('mouseup', pointerUp);
                document.removeEventListener('touchmove', pointerMove);
                document.removeEventListener('touchend', pointerUp);
            }

            handleEl.addEventListener('mousedown', pointerDown);
            handleEl.addEventListener('touchstart', pointerDown, { passive: true });
        }

        /**********************
         * Map Initialization
         **********************/
        const map = L.map('map', {
            attributionControl: false
        }).setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ''
        }).addTo(map);
        L.marker([19.0760, 72.8777]).addTo(map).bindPopup('Mumbai: Flood Alert');
        L.marker([28.6139, 77.2090]).addTo(map).bindPopup('Delhi: Heat Wave Warning');
        L.marker([13.0827, 80.2707]).addTo(map).bindPopup('Chennai: Cyclone Watch');
        const polyline = L.polyline([[19.0760, 72.8777], [19.1020, 72.9000], [19.15, 72.93]], { color: 'green' }).addTo(map);
        polyline.bindPopup("Evacuation Route: Low Traffic");

        /**********************
        * Menu Navigation
        *********************/

        function initializeMenuNavigation() {
            const menuItems = document.querySelectorAll('.menu-item');

            // Define page mappings for each menu item
            const pageMapping = {
                'Dashboard': 'dashboard-student.html',
                'Education Modules': 'education-modules.html',
                'Sandbox Simulator': 'sandbox-simulator.html',
                'Emergency Contacts': '../emergency_contacts.html', // Scroll to emergency contacts section
                "Do's & Dont's": '../dos&donts.html',
                'Drill Schedule': '../drill_schedule.html',
                'Disaster Map': '../advanced-map.html',
                'AI Helper': 'chatbot.html',
                'Gamified Learning': 'gamified-learning.html',
                'Profile & Badges': 'profile-badges.html',
                'Settings': 'settings.html'
            };

            menuItems.forEach(item => {
                item.addEventListener('click', function () {
                    // Update active state
                    menuItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');

                    // Get the menu item text
                    const menuText = this.querySelector('span').textContent.trim();
                    const targetPage = pageMapping[menuText];

                    if (targetPage) {
                        if (targetPage.startsWith('#')) {
                            // Handle anchor links (scroll to section)
                            if (targetPage === '#emergency-contacts') {
                                document.querySelector('.emergency-contacts-section').scrollIntoView({
                                    behavior: 'smooth'
                                });
                            }
                        } else {
                            // Navigate to page
                            navigateToPage(targetPage, menuText);
                        }
                    }
                });

                // Add hover effect
                item.addEventListener('mouseenter', function () {
                    if (!this.classList.contains('active')) {
                        this.style.backgroundColor = 'rgba(255, 255, 255, 0.15)';
                    }
                });

                item.addEventListener('mouseleave', function () {
                    if (!this.classList.contains('active')) {
                        this.style.backgroundColor = '';
                    }
                });
            });
        }

        function navigateToPage(targetPage, menuText) {
            // Show loading indicator
            showLoadingIndicator();

            // Add smooth transition
            document.body.style.opacity = '0.8';
            document.body.style.transition = 'opacity 0.3s ease';

            setTimeout(() => {
                try {
                    window.location.href = targetPage;
                } catch (error) {
                    console.error('Navigation error:', error);
                    hideLoadingIndicator();
                    showNavigationError(menuText);
                    document.body.style.opacity = '1';
                }
            }, 300);
        }

        function showLoadingIndicator() {
            // Create loading overlay if it doesn't exist
            if (!document.getElementById('loadingOverlay')) {
                const loadingHTML = `
                    <div id="loadingOverlay" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(26, 115, 232, 0.9);
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        z-index: 9999;
                        color: white;
                    ">
                        <div style="
                            width: 50px;
                            height: 50px;
                            border: 3px solid rgba(255, 255, 255, 0.3);
                            border-top: 3px solid white;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                            margin-bottom: 20px;
                        "></div>
                        <h3>Loading...</h3>
                        <p>Navigating to your selected page</p>
                    </div>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `;
                document.body.insertAdjacentHTML('beforeend', loadingHTML);
            }
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoadingIndicator() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function showNavigationError(menuText) {
            alert(`âš ï¸ Navigation Error\n\nSorry, the ${menuText} page is currently unavailable.\n\nThis might be because:\nâ€¢ The page is still being developed\nâ€¢ The file path has changed\nâ€¢ There's a temporary server issue\n\nPlease try again later or contact support.`);
        }

        // Add keyboard navigation
        function initializeKeyboardNavigation() {
            document.addEventListener('keydown', function (e) {
                if (e.altKey) {
                    const menuItems = document.querySelectorAll('.menu-item');
                    const currentActive = document.querySelector('.menu-item.active');
                    let currentIndex = Array.from(menuItems).indexOf(currentActive);

                    if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                        e.preventDefault();
                        currentIndex = currentIndex > 0 ? currentIndex - 1 : menuItems.length - 1;
                        menuItems[currentIndex].click();
                    } else if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                        e.preventDefault();
                        currentIndex = currentIndex < menuItems.length - 1 ? currentIndex + 1 : 0;
                        menuItems[currentIndex].click();
                    }
                }
            });
        }


        /**********************
         * Emergency Modal HTML
         **********************/
        <!-- Replace the existing emergencyModalHTML variable with this: -->
        const emergencyModalHTML = `
    <div class="modal-overlay" id="emergencyOverlay" style="display:none;">
      <div class="modal" id="emergencyModal" role="dialog" aria-modal="true" style="max-width: 500px;">
        <div class="modal-header" id="emergencyHeader">
          <strong style="display:flex;align-items:center;gap:12px">
            <i class="fas fa-exclamation-triangle" style="color:var(--accent)"></i> 
            Emergency Alert System
          </strong>
          <div>
            <button class="modal-close" id="closeEmergency"><i class="fas fa-times"></i></button>
          </div>
        </div>
        <div class="modal-body" style="padding-bottom:30px;">
          <!-- Voice Recognition Section -->
          <div class="voice-recognition">
            <h3 style="margin-bottom: 15px; color: #d32f2f;">
              <i class="fas fa-microphone"></i> Voice Emergency Report
            </h3>
            
            <div class="voice-status" id="voiceStatus">
              Click the microphone and describe your emergency
            </div>
            
            <button class="voice-button" id="voiceButton">
              <i class="fas fa-microphone"></i>
            </button>
            
            <div class="voice-transcript">
              <div class="voice-transcript-text" id="voiceTranscript">
                Your voice description will appear here...
              </div>
            </div>
            
            <div class="voice-actions">
              <button class="alert-btn" id="clearVoice">
                <i class="fas fa-eraser"></i> Clear
              </button>
              <button class="alert-btn primary" id="useVoiceText">
                <i class="fas fa-check"></i> Use This Text
              </button>
            </div>
          </div>

          <div style="border-top: 1px solid #eee; margin: 20px 0; padding-top: 20px;">
            <p style="color:#444; margin-bottom: 15px;">
              Or select the type of disaster manually:
            </p>
            
            <div class="emergency-categories">
              <div class="emergency-category" data-type="flood">
                <i class="fas fa-water" style="font-size:18px;color:#2196F3"></i>
                <div style="margin-top:6px;font-weight:700">Flood</div>
              </div>
              <div class="emergency-category" data-type="earthquake">
                <i class="fas fa-mountain" style="font-size:18px;color:#795548"></i>
                <div style="margin-top:6px;font-weight:700">Earthquake</div>
              </div>
              <div class="emergency-category" data-type="fire">
                <i class="fas fa-fire" style="font-size:18px;color:#f44336"></i>
                <div style="margin-top:6px;font-weight:700">Fire</div>
              </div>
              <div class="emergency-category" data-type="medical">
                <i class="fas fa-heart" style="font-size:18px;color:#4caf50"></i>
                <div style="margin-top:6px;font-weight:700">Medical</div>
              </div>
              <div class="emergency-category" data-type="storm">
        <i class="fas fa-wind" style="font-size:18px;color:#9C27B0"></i>
        <div style="margin-top:6px;font-weight:700">Storm/Cyclone</div>
    </div>
    <div class="emergency-category" data-type="landslide">
        <i class="fas fa-mountain" style="font-size:18px;color:#8D6E63"></i>
        <div style="margin-top:6px;font-weight:700">Landslide</div>
    </div>
    
    <div class="emergency-category" data-type="building_collapse">
        <i class="fas fa-building" style="font-size:18px;color:#757575"></i>
        <div style="margin-top:6px;font-weight:700">Building Collapse</div>
    </div>
    <div class="emergency-category" data-type="tsunami">
        <i class="fas fa-water" style="font-size:18px;color:#1565C0"></i>
        <div style="margin-top:6px;font-weight:700">Other</div>
    </div>
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:18px;flex-wrap:wrap">
            <button id="confirmEmergency" class="alert-btn primary" style="flex:1;padding:12px 16px"> 
              <i class="fas fa-phone"></i> Send Emergency Alert
            </button>
            <button id="cancelEmergency" class="alert-btn" style="padding:12px 16px">Cancel</button>
          </div>
        </div>
      </div>
    </div>
`;
        document.body.insertAdjacentHTML('beforeend', emergencyModalHTML);

        /**********************
         * Details modal (for alert "Details")
         **********************/
        const detailsModalHTML = `
            <div class="modal-overlay" id="detailsOverlay" style="display:none;">
              <div class="modal" id="detailsModal" role="dialog" aria-modal="true">
                <div class="modal-header" id="detailsHeader">
                  <strong id="detailsTitle">Alert Details</strong>
                  <div>
                    <button class="modal-close" id="closeDetails"><i class="fas fa-times"></i></button>
                  </div>
                </div>
                <div class="modal-body" id="detailsBody">
                  <!-- populated dynamically -->
                </div>
              </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', detailsModalHTML);

        /**********************
         * Wire up emergency modal interactions
         **********************/
        const emergencyOverlay = document.getElementById('emergencyOverlay');
        const emergencyModal = document.getElementById('emergencyModal');
        const emergencyHeader = document.getElementById('emergencyHeader');
        const emergencyBtn = document.getElementById('emergencyBtn');
        const closeEmergency = document.getElementById('closeEmergency');
        const confirmEmergency = document.getElementById('confirmEmergency');
        const cancelEmergency = document.getElementById('cancelEmergency');
        let selectedDisasterType = null;

        // open modal
        // open modal - FIXED VERSION
        emergencyBtn.addEventListener('click', () => {
            emergencyOverlay.style.display = 'flex';
            selectedDisasterType = null;

            // Reset UI
            document.querySelectorAll('.emergency-category').forEach(cat => {
                cat.classList.remove('selected');
            });

            document.getElementById('confirmEmergency').disabled = false;

            document.getElementById('voiceStatus').textContent = 'Click microphone to speak';
            document.getElementById('voiceTranscript').textContent = 'Your voice description will appear here...';

            // Initialize voice recognition after a short delay
            setTimeout(() => {
                initializeVoiceRecognition();
            }, 500);

            // Manual category selection (BACKUP)
            document.querySelectorAll('.emergency-category').forEach(btn => {
                btn.onclick = () => {
                    selectedDisasterType = btn.dataset.type;
                    document.querySelectorAll('.emergency-category').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                };
            });
        });

        closeEmergency.addEventListener('click', () => emergencyOverlay.style.display = 'none');
        cancelEmergency.addEventListener('click', () => emergencyOverlay.style.display = 'none');

        confirmEmergency.addEventListener('click', () => {
            if (!selectedDisasterType) {
                alert('Please select a disaster type or use voice recognition');
                return;
            }

            const voiceText = document.getElementById('voiceTranscript').textContent;
            let alertMessage;

            if (voiceText && !voiceText.includes('Your voice description')) {
                alertMessage = `VOICE REPORT: "${voiceText}". ${selectedDisasterType.toUpperCase()} emergency confirmed.`;
            } else {
                alertMessage = `Manual report: ${selectedDisasterType.toUpperCase()} emergency. Response teams notified.`;
            }

            // Add to alerts
            addNewAlert('emergency', selectedDisasterType.toUpperCase() + ' Alert', alertMessage, 'just now');
            emergencyOverlay.style.display = 'none';

            // Update status
            document.querySelector('.status-indicator').className = 'status-indicator help';
            document.querySelector('.status-indicator').innerHTML =
                '<i class="fas fa-exclamation-triangle"></i><span>EMERGENCY - ' + selectedDisasterType.toUpperCase() + '</span>';
        });

        // make emergency modal draggable
        makeDraggable(emergencyModal, emergencyHeader);

        /**********************
         * Details modal interactions
         **********************/
        const detailsOverlay = document.getElementById('detailsOverlay');
        const detailsModal = document.getElementById('detailsModal');
        const detailsHeader = document.getElementById('detailsHeader');
        const detailsTitle = document.getElementById('detailsTitle');
        const detailsBody = document.getElementById('detailsBody');
        const closeDetails = document.getElementById('closeDetails');

        closeDetails.addEventListener('click', () => detailsOverlay.style.display = 'none');
        makeDraggable(detailsModal, detailsHeader);

        // wire "Details" buttons
        function wireDetailsButtons() {
            document.querySelectorAll('.details-btn').forEach(btn => {
                btn.onclick = function () {
                    const alertItem = btn.closest('.alert-item');
                    const title = alertItem.querySelector('h4').innerText;
                    const message = alertItem.querySelector('p').innerText;
                    const meta = alertItem.querySelector('.alert-meta').innerText;
                    detailsTitle.innerText = title;
                    detailsBody.innerHTML = `
                        <p style="color:#444">${message}</p>
                        <div style="margin-top:12px;font-size:13px;color:#777"><strong>Meta:</strong> ${meta}</div>
                        <div style="margin-top:18px;display:flex;gap:8px">
                          <button class="alert-btn primary" id="ackNow">Acknowledge</button>
                          <button class="alert-btn" id="escalate">Escalate</button>
                        </div>
                    `;
                    detailsOverlay.style.display = 'flex';
                    // make sure container scrolls to top
                    detailsBody.scrollTop = 0;

                    // add handlers
                    document.getElementById('ackNow').onclick = () => {
                        alert('Acknowledged. Authorities notified for follow-up.');
                        detailsOverlay.style.display = 'none';
                    };
                    document.getElementById('escalate').onclick = () => {
                        alert('Escalation sent. Response teams prioritized this alert.');
                        detailsOverlay.style.display = 'none';
                    };
                };
            });
        }
        wireDetailsButtons();

        /**********************
         * Mark as read for alert items (and update counts)
         **********************/
        function updateAlertCounts() {
            const count = document.querySelectorAll('#alertsContainer .alert-item').length;
            document.getElementById('alertsCount').innerText = count;
            document.getElementById('activeAlerts').innerText = count;
        }

        document.querySelectorAll('.mark-read').forEach(btn => {
            btn.addEventListener('click', function () {
                const item = btn.closest('.alert-item');
                item.style.opacity = '0.55';
                btn.textContent = 'Read';
                btn.disabled = true;
                // reduce counts only logically (we keep item but mark as read)
                updateAlertCounts();
            });
        });

        /**********************
         * Add new alert helper (used by emergency confirm + simulated updates)
         **********************/
        function getAlertIcon(type) {
            const icons = { emergency: 'fa-exclamation-triangle', severe: 'fa-bolt', warning: 'fa-water', info: 'fa-info-circle' };
            return icons[type] || 'fa-bell';
        }

        function addNewAlert(type, title, message, time) {
            const alertsContainer = document.getElementById('alertsContainer');
            const el = document.createElement('div');
            el.className = 'alert-item ' + (type || 'info');
            el.innerHTML = `
                <div class="alert-icon"><i class="fas ${getAlertIcon(type)}"></i></div>
                <div class="alert-content">
                  <h4>${title}</h4>
                  <p>${message}</p>
                  <div class="alert-meta"><span class="alert-time">${time}</span><span class="alert-region">Your Area</span></div>
                </div>
                <div class="alert-actions">
                  <button class="alert-btn primary details-btn">Details</button>
                  <button class="alert-btn mark-read">Mark Read</button>
                </div>
            `;
            alertsContainer.insertAdjacentElement('afterbegin', el);
            // wire buttons
            el.querySelector('.mark-read').addEventListener('click', function () {
                this.textContent = 'Read'; this.disabled = true; el.style.opacity = '0.55';
                updateAlertCounts();
            });
            el.querySelector('.details-btn').addEventListener('click', function () {
                wireDetailsButtons(); // ensure handler up to date then trigger click
                this.click();
            });
            // update badges
            updateAlertCounts();
            // bounce highlight
            el.classList.add('highlight');
            setTimeout(() => el.classList.remove('highlight'), 1200);
        }

        /**********************
         * Simulate real-time alerts occasionally
         **********************/
        function startRealTimeAlerts() {
            setInterval(() => {
                if (Math.random() > 0.78) {
                    const types = ['info', 'warning'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    const pool = {
                        info: { title: 'Weather Update', message: 'Clear skies expected for the next 6 hours. Good conditions for outdoor activities.' },
                        warning: { title: 'Traffic Alert', message: 'Heavy traffic reported on major routes due to ongoing construction work.' }
                    };
                    const chosen = pool[type];
                    addNewAlert(type, chosen.title, chosen.message, 'just now');
                }
            }, 30000);
        }
        startRealTimeAlerts();

        /********************
         * DISASTER ATTENDANCE SYSTEM
         ********************/

        function markSafe() {
            const statusIndicator = document.querySelector('.status-indicator');
            statusIndicator.className = 'status-indicator safe';
            statusIndicator.innerHTML = '<i class="fas fa-check-circle"></i><span>You are marked SAFE</span>';

            const lastCheckin = document.querySelector('.last-checkin');
            lastCheckin.textContent = 'Last check-in: ' + new Date().toLocaleString();

            // Notify authorities if emergency is active
            if (isEmergencyActive) {
                addNewAlert('info', 'Safety Status Updated',
                    'Your safety status has been reported to emergency authorities.', 'now');
            }
        }

        function requestHelp() {
            const statusIndicator = document.querySelector('.status-indicator');
            statusIndicator.className = 'status-indicator help';
            statusIndicator.innerHTML = '<i class="fas fa-hand-paper"></i><span>HELP REQUESTED</span>';

            alert('ðŸ†˜ HELP REQUEST SENT!\n\nYour request for help has been sent to:\nâ€¢ Emergency Services\nâ€¢ NDRF\nâ€¢ Local Authorities\nâ€¢ Medical Teams\n\nImmediate assistance is being dispatched to your location.');

            addNewAlert('emergency', 'Help Request Prioritized',
                'Your help request has been marked as high priority. Rescue teams are being dispatched immediately.', 'now');
        }

        function shareLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    alert(`ðŸ“ LOCATION SHARED\n\nLatitude: ${lat.toFixed(6)}\nLongitude: ${lon.toFixed(6)}\n\nYour location has been shared with emergency services and authorities.`);

                    addNewAlert('info', 'Location Shared Successfully',
                        'Your GPS coordinates have been sent to emergency response teams.', 'now');
                }, function (error) {
                    alert('Unable to get your location. Please ensure location services are enabled.');
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        /**********************
         * Search functionality - finds matches across alerts, resources, contacts & stats; moves matched element to top and highlights
         **********************/
        // const searchInput = document.getElementById('searchInput');
        // const searchBtn = document.getElementById('searchBtn');
        // const clearSearch = document.getElementById('clearSearch');

        // function doSearch() {
        //     const q = searchInput.value.trim().toLowerCase();
        //     document.querySelectorAll('.highlight').forEach(h => h.classList.remove('highlight'));
        //     if (!q) {
        //         clearSearch.style.display = 'none';
        //         return;
        //     }
        //     clearSearch.style.display = 'inline-block';
        //     // search alerts by title and content
        //     let found = false;
        //     document.querySelectorAll('#alertsContainer .alert-item').forEach(item => {
        //         const title = item.querySelector('h4').innerText.toLowerCase();
        //         const body = item.querySelector('p').innerText.toLowerCase();
        //         if (title.includes(q) || body.includes(q)) {
        //             // move to top of alerts container
        //             const parent = document.getElementById('alertsContainer');
        //             parent.insertBefore(item, parent.firstChild);
        //             item.classList.add('highlight');
        //             item.scrollIntoView({ behavior: 'smooth', block: 'center' });
        //             found = true;
        //         }
        //     });
        //     // search resources
        //     document.querySelectorAll('#resourcesGrid .resource-card').forEach(card => {
        //         const title = card.querySelector('h3').innerText.toLowerCase();
        //         const body = card.querySelector('p').innerText.toLowerCase();
        //         if (title.includes(q) || body.includes(q)) {
        //             document.getElementById('resourcesGrid').insertBefore(card, document.getElementById('resourcesGrid').firstChild);
        //             card.classList.add('highlight');
        //             card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        //             found = true;
        //         }
        //     });
        //     // search contacts
        //     document.querySelectorAll('.contact-card').forEach(card => {
        //         const region = card.querySelector('.contact-header h4').innerText.toLowerCase();
        //         if (region.includes(q)) {
        //             document.querySelector('.contacts-grid').insertBefore(card, document.querySelector('.contacts-grid').firstChild);
        //             card.classList.add('highlight');
        //             card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        //             found = true;
        //         }
        //     });
        //     // search stats
        //     document.querySelectorAll('.stat-info h3').forEach(h => {
        //         const parentCard = h.closest('.card');
        //         if (h.innerText.toLowerCase().includes(q)) {
        //             parentCard.parentNode.insertBefore(parentCard, parentCard.parentNode.firstChild);
        //             parentCard.classList.add('highlight');
        //             parentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        //             found = true;
        //         }
        //     });

        //     if (!found) {
        //         // subtle feedback
        //         searchInput.style.boxShadow = '0 6px 18px rgba(226,26,47,0.08)';
        //         setTimeout(() => searchInput.style.boxShadow = '', 800);
        //     } else {
        //         // small success feedback (clear after)
        //         setTimeout(() => document.querySelectorAll('.highlight').forEach(h => h.classList.remove('highlight')), 2500);
        //     }
        // }

        // searchBtn.addEventListener('click', doSearch);
        // searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') doSearch(); });
        // clearSearch.addEventListener('click', () => { searchInput.value = ''; clearSearch.style.display = 'none'; });

        /**********************
         * Chat History Management
         **********************/

        // Chat session tracking
        let currentChatId = null;
        let chatStartTime = null;
        let sessionMessages = [];

        // Initialize or get existing chat session
        function initializeChatSession() {
            if (!currentChatId) {
                currentChatId = generateChatId();
                chatStartTime = new Date();
                sessionMessages = [
                    {
                        type: 'bot',
                        content: "Hi, what's new today??",
                        timestamp: new Date()
                    }
                ];
            }
        }

        // Generate unique chat ID
        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Save chat session to localStorage
        function saveChatSession() {
            if (!currentChatId || sessionMessages.length <= 1) return; // Don't save empty chats

            const chatData = {
                id: currentChatId,
                title: generateChatTitle(),
                startTime: chatStartTime,
                lastUpdate: new Date(),
                messages: sessionMessages,
                source: 'dashboard' // Indicates this came from dashboard page
            };

            // Get existing chats
            const existingChats = JSON.parse(localStorage.getItem('disasterAI_chatHistory') || '[]');

            // Check if chat already exists and update it, or add new
            const existingIndex = existingChats.findIndex(chat => chat.id === currentChatId);
            if (existingIndex >= 0) {
                existingChats[existingIndex] = chatData;
            } else {
                existingChats.unshift(chatData); // Add to beginning
            }

            // Keep only last 50 chats to prevent storage overflow
            if (existingChats.length > 50) {
                existingChats.splice(50);
            }

            localStorage.setItem('disasterAI_chatHistory', JSON.stringify(existingChats));
        }

        // Generate a descriptive title for the chat based on first user message
        function generateChatTitle() {
            const firstUserMessage = sessionMessages.find(msg => msg.type === 'user');
            if (firstUserMessage) {
                let title = firstUserMessage.content.substring(0, 40);
                if (firstUserMessage.content.length > 40) title += '...';
                return title;
            }
            return 'New Conversation';
        }

        /**********************
         * Quick-call buttons
         **********************/
        document.querySelectorAll('.quick-call').forEach(b => {
            b.addEventListener('click', () => {
                const number = b.dataset.number;
                if (confirm(`Call ${number}?`)) {
                    window.open(`tel:${number}`);
                }
            });
        });

        /**********************
         * Make sure details buttons and mark-read buttons are wired for initial DOM
         **********************/
        document.querySelectorAll('.details-btn').forEach(btn => btn.addEventListener('click', function () {
            // handled by wireDetailsButtons but double-ensure
            wireDetailsButtons();
            this.click();
        }));

        document.querySelectorAll('.mark-read').forEach(btn => {
            btn.addEventListener('click', function () {
                this.textContent = 'Read'; this.disabled = true; this.closest('.alert-item').style.opacity = '0.55';
                updateAlertCounts();
            });
        });

        // initial counts
        updateAlertCounts();

        /**********************
         * Accessibility / keyboard navigation for menu
         **********************/
        document.querySelectorAll('.menu-item').forEach((mi, idx, arr) => {
            mi.addEventListener('click', () => {
                arr.forEach(i => i.classList.remove('active'));
                mi.classList.add('active');
                // scroll to section links
                const text = mi.querySelector('span').innerText.trim();
                if (text === 'Emergency Contacts') document.querySelector('.emergency-contacts-section').scrollIntoView({ behavior: 'smooth' });
                if (text === 'Disaster Map') document.querySelector('#map').scrollIntoView({ behavior: 'smooth' });
            });
            mi.tabIndex = 0;
        });

        /**********************
         * Make sure draggable modals can be closed by ESC
         **********************/
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('emergencyOverlay').style.display = 'none';
                document.getElementById('detailsOverlay').style.display = 'none';
            }
        });

        /**********************
         * Ensure modal focus trap is minimal (demo)
         **********************/

        /**********************
         * Finally: ensure modals are draggable initially
         **********************/
        // already applied emergency & details via makeDraggable above

        /**********************
         * Minor improvements: clicking on an alert-details button fills details modal
         * (we re-wire to make sure it works after dynamic adds)
         **********************/
        // re-wire whenever new alerts are added
        const observer = new MutationObserver(() => {
            wireDetailsButtons();
            document.querySelectorAll('.mark-read').forEach(btn => {
                if (!btn.hasAttribute('data-wired')) {
                    btn.setAttribute('data-wired', '1');
                    btn.addEventListener('click', function () { this.textContent = 'Read'; this.disabled = true; this.closest('.alert-item').style.opacity = '0.55'; updateAlertCounts(); });
                }
            });
        });
        observer.observe(document.getElementById('alertsContainer'), { childList: true, subtree: true });

        initializeMenuNavigation();
        initializeKeyboardNavigation();
    </script>
</body>

</html>